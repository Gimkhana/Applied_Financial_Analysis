---
title: "Consolidated_Clauss_GRA"
output: html_document
date: "`r Sys.Date()`"
---

# 1. Global Minimum Volatility portfolio (GMV) on an equity portfolio 

## 1.1 Packages

We import the necessary libraries to perform the first analysis.

1.  library(tidyverse): The tidyverse package constitutes a collection of R packages meticulously designed to work seamlessly in unison for data manipulation, visualization, and analysis. It encompasses packages like ggplot2 for data visualization, dplyr for data manipulation, tidyr for data tidying, and more. Loading tidyverse avails all these packages for utilization during your R session, streamlining your data analysis workflow.

2.  library(quantmod): The quantmod package primarily caters to quantitative financial modeling and analysis. It furnishes an array of functions and tools for handling financial data, such as downloading and managing stock price data, conducting technical analysis, and modeling financial time series.

3.  library(DataExplorer): The DataExplorer package serves the purpose of preliminary data exploration and analysis. It offers functions to generate summary statistics, visualize missing data, plot variable distributions, and more. It can aid in obtaining a quick overview of your data before delving into more extensive analyses.

4.  library(corrplot): The corrplot package specializes in visualizing correlation matrices. It provides functions for generating visually appealing and informative correlation plots, which prove valuable for comprehending relationships between variables within your data.

5.  library(scales): The scales package provides an assortment of scales and formatting functions tailored for R graphics. It is often employed in conjunction with other plotting packages, such as ggplot2, to customize the appearance of plots, including axes, labels, and color scales.

```{r}
library(tidyverse)
library(quantmod)
library(DataExplorer)
library(corrplot)
library(scales)
```

## 1.2 Investment universe

In our portfolio management project, we have carefully chosen a set of twenty stocks from a larger universe of investments. This selection represents the most significant companies in the US equity market, primarily based on their market capitalization. By analyzing these stocks, our objective is to gain valuable insights into the strategies that can be employed for managing investments in the US equity market.

Our choice of stocks is guided by several key considerations:

-   Investment universe: Our selection is drawn from a universe of stocks that encompasses twenty well-established companies within the US equity market. These companies are known for their substantial market presence and are recognized leaders in their respective industries.

-   Market capitalization focus: We have chosen stocks with an emphasis on market capitalization. Larger market capitalization often indicates stability and lower volatility, making these stocks appealing for various investment strategies.

-   US equity market perspective: Our project primarily targets insights related to the US equity market. The chosen stocks provide a representative snapshot of the investment landscape in one of the world's largest and most influential equity markets.

-   Diversification: To create a well-rounded portfolio, we have ensured diversification across different sectors and industries. Diversification is essential in portfolio management as it spreads risk and mitigates overexposure to a single sector.

-   Market visibility: The selected companies are not only well-regarded in the financial sector but are also widely recognized in popular culture. Their performance is closely monitored, and they often hold significant sway over market indices.

-   Historical data and research: These stocks have a rich history of performance data and have been the subject of extensive research. Access to their historical data is abundant, making them suitable for rigorous portfolio management analysis and research.

The provided R code defines the stock tickers for these companies, allowing you to access financial data. This data can then be employed to conduct a range of analyses, such as return calculations, risk assessments, and portfolio optimization, to test and implement various investment strategies on the US equity market.

```{r}
# Define the stock tickers you want to fetch data for
stock_tickers <- c("AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "NVDA", "PYPL", "CMCSA", "ADBE", "ASML",
                   "CSCO", "PEP", "AVGO", "TMUS", "INTC", "TXN", "AMGN", "NFLX", "SBUX", "AMAT")
```

We source our data from Yahoo Finance, a highly reputable platform renowned for its financial data. Our analysis covers a comprehensive three-and-a-half-year period, allowing us to evaluate the performance of our selected companies both before and after the onset of the COVID-19 pandemic.

```{r}
# Fetch historical stock data from Yahoo Finance
start_date <- "2019-01-01"  # Replace with your desired start date
end_date <- "2023-08-31"    # Replace with your desired end date
stock_data <- getSymbols(stock_tickers, from = start_date, to = end_date, auto.assign = TRUE)
```

## 1.3 Data cleaning

We perform some formatting to clean the data, an important step in performing data analysis:

-   Extracting Adjusted Closing Prices: lapply(stock_tickers, function(ticker) { Ad(get(ticker)) }): This code uses the lapply function to retrieve the adjusted closing prices (often used for return calculations) for a list of stock tickers. It iterates through each ticker in the stock_tickers vector and fetches the adjusted closing prices using the Ad() function from the quantmod package.

-   Combining Stock Returns: do.call(cbind, stock_returns): The code combines the extracted adjusted closing prices into a single data frame by calling cbind (column-bind) on the list of stock returns obtained in the previous step. This creates a data frame where each column represents the adjusted closing prices of a specific stock.

-   Renaming Columns: colnames(fin_prices) \<- stock_tickers: The code assigns the stock tickers as column names to the combined data frame. This step ensures that each column is labeled with the corresponding stock ticker, making it easier to identify each stock's data.

-   Handling Missing Data: na.omit(fin_prices): This line of code removes rows with missing values (usually represented as NA) from the combined data frame, fin_prices. Removing missing data is a common preprocessing step to ensure the quality and consistency of the dataset for further analysis.

```{r}
# Extract adjusted closing prices (which are typically used for returns)
stock_returns <- lapply(stock_tickers, function(ticker) {
  Ad(get(ticker))
})

# Combine stock returns into a single data frame
fin_prices <- do.call(cbind, stock_returns)

# Rename columns to match your analysis
colnames(fin_prices) <- stock_tickers

# Eliminated missing data in time series
fin_return <- na.omit(fin_prices)  # Remove rows with missing values
```

We perform the arithmetic return method to compute returns for this data set. It is simple, intuitive and widely accessible. Arithmetic returns are particularly useful for performance measurement, providing a clear view of actual gains and losses. It is well-suited for short-term analysis and offer transparency.

```{r}
arith_fin_returns = diff(fin_return)/lag(fin_return)
head(arith_fin_returns, n=3)
arith_fin_returns <- arith_fin_returns[-1, ]
```

In order to ensure that the data is properly imported, with non missing valiues and proper data cleaning procedure, we can implement this line of code in order to learn more about data.

```{r}
plot_intro(arith_fin_returns)
```

From the figure below, Tesla's stock (TICKER: TSLA) witnessed an unprecedented surge in attraction, making it a notable standout within our investment universe.

Tesla's performance distinctly outpaced the broader investment universe. The surge in retail trading interest for the electric car company can explain to some extent this massive performance, especially in the wake of the post-COVID market, where intensive monetary policies prompted significant investments from both corporate and retail investors seeking higher yields.

The code allowed us to plot returns into a time series, providing a clear visualization of stock performance during the specified period.

```{r}
# Calculate Cumulative Returns
cumulative_returns <- cumprod(1 + arith_fin_returns)

# Plot Cumulative Return Performance
library(ggplot2)
autoplot(cumulative_returns, facets = NULL) +
  ggtitle("Cumulative Return Performance of the investment universe") +
  ylab("Cumulative Return") +
  xlab("Year")

```

We can define the minimum volatility portfolio as a portfolio of assets with the lowest possible risk for an investor and is located on the far-left side of the efficient frontier. Note that the minimum volatility portfolio is also called the minimum variance portfolio or more precisely the global minimum volatility portfolio (to distinguish it from other optimal portfolios obtained for higher risk levels).

To implement to global minimum variance portfolio, we need to compute the covariance matrix as an input parameter for the Markowitz optimization model.

```{r}
cov_matrix <- cov(arith_fin_returns)

```

Correlation plays an important role in a Markowitz allocation framework, where diversification can be achieved when allocating capital to poorly or negatively correlated assets.

The concept of diversification seeks to enhance returns while minimizing risk by investing in a variety of assets that will react differently to the same event (s). For example, whenever there is unfavorable news about a certain event, i.e. 2008 subprime mortgage crisis, the stock market typically declines dramatically. Simultaneously, the same news has generally benefited the price of specific assets, such as gold. As a result, portfolio diversification should include not just diverse stocks inside and outside of the same industry, but also diverse asset classes, such as bonds and commodities. The diversification effect is a term that relates to the link between portfolio correlations and diversification. When there is an imperfect correlation between assets (positive or negative), the diversification effect occurs. It is a critical and successful risk mitigation method since risk mitigation may be accomplished without sacrificing profits. As a result, any prudent investor who is 'risk cautious' will diversify to a certain extent.

Here, we observe opportunities for diversification within our investment universe. For instance, we notice that stocks often categorized as defensive plays can serve as effective diversification instruments when combined with more aggressive stocks. In this context, consider Amgen Inc. (TICKER: AMGN) in the healthcare industry, which exhibits a neutral correlation when compared to a stock like Tesla (TICKER: TSLA). Similar logic applies to a stock such as PepsiCo Inc. (TICKER: PEP) in relation to Tesla. It's worth noting that within our investment universe, we do not find negative correlations, as all the assets exhibit some degree of correlation to one another.

```{r}
corrplot(cor(arith_fin_returns), type='lower', 
         method = "shade", tl.col = 'black', cl.pos = "r", tl.cex = 1)
```

To further complement the analysis of the data gathered, we can run a statistical analysis of the first moments of the distribution to assess the performance of each stock and understand their behavior during the timeframe observed. NB: Figures obtained from this statistical analysis are given on a daily return basis.

```{r}
summary(arith_fin_returns)
```

In portfolio management, statistical analysis can help understand financial patterns in data.

First, density plots, also known as probability density function plots, serve the purpose of visualizing data distributions. They offer insights into the shape, spread, and central tendencies of data, making them crucial for assessing the nature of financial asset returns.

Second, QQ plots, or quantile-quantile plots, are utilized to evaluate whether a dataset adheres to a specific theoretical distribution, such as the normal distribution. These plots help portfolio managers identify departures from expected distributions, facilitating informed investment decisions. Together, these techniques aid in the exploration and assessment of financial data, enabling portfolio managers to make more informed and data-driven choices in their investment strategies.

We can run some more advanced statistical analysis to understand the asset return behavior of the equities selected in this analysis.

```{r}

# Advanced statistical analysis for the dataset

#plot_density(arith_fin_returns)
plot_qq(arith_fin_returns)

```

# 2. Modelling part

Modern Portfolio Theory (MPT) is founded on several market and investor assumptions. Several of these assumptions are stated explicitly, while others are implied. Markowitz's contributions to (MPT) in portfolio selection are based on the following basic assumptions: 

-   Investors are rational (they seek to maximize returns while minimizing risk, or minimize risk while maximize return).

-   Investors will accept increased risk only if compensated with higher expected returns.

-   Investors receive all relevant information regarding their investment decision.

-   Investors can borrow or lend an unlimited amount of capital at a risk-free rate of interest.

## 2.1 Unbiased Global Minimum Variance (GMV) portfolio

In the context of time series data analysis, one of the crucial applications is the division of the data set into a training set and a testing set based on temporal order. This approach is particularly important when dealing with data that evolves over time, such as stock prices, weather observations, or economic indicators.

The training set typically comprises historical data, while the testing set contains more recent observations. This temporal separation allows for the evaluation of predictive models and forecasting techniques. By using historical data to train the model and then assessing its performance on more recent data, analysts can gauge the model's ability to make accurate predictions and anticipate future trends. Time series data applications are essential in fields like finance, where understanding and forecasting trends over time is important.

For the purpose of modelling, we will shrink the data set into two different sub-samples. We can define the following parameters:

```{r}
num_rows_subsample1 <- 400
total_rows <- nrow(arith_fin_returns)
```

1.  The first sub-sample will cover the first 400 trading days covered in the data set.

```{r}
subsample1 <- arith_fin_returns[1:num_rows_subsample1, ]
plot_intro(subsample1)
```

2.  The second sub-sample will cover the rest of the data set, covering the equivalent of 773 trading days.

```{r}
subsample2 <- arith_fin_returns[(num_rows_subsample1 + 1):total_rows, ]
plot_intro(subsample2)

```

We implement the parameters of the model in order to compute the GMV:

```{r}

#Definition of parameters
n <- ncol(subsample1)
T <- nrow(subsample1)
e <- rep(1, n)
perio <- 12

#Compute Sigma (unbiased covariance matrix)
Sigma <- cov(subsample1) * (T - 1) / (T - n - 2) * perio
C <- t(e) %*% solve(Sigma) %*% e

#Anticipated volatility can be computed
sigmag <- sqrt(1 / C)
```

After computing the parameters required to implement the unbiased GMV portfolio, we can compute omega, representing the weightings of the portfolio as follows.

```{r}
omega_gmv <- 1 / as.numeric(C) * solve(Sigma) %*% e
```

We can see in this instance that the portfolio is mixed, with some long and short positions. The capital is fully invested, with some important exposure in the long part of the portfolio on stocks like Amazon (TICKER: AMZN) with 39.85%, followed by PepsiCo (TICKER: PEP) at 29.45% and ASML (TICKER: ASML) at 26.35%.

On the short part of the portfolio, we can see an important short on three stocks that can stand out: Applied Materials Inc. (TICKER: AMAT) -24.07%, Adobe (TICKER: ADBE) at -19.90% and NVIDIA Corp. (TICKER: NVDIA) at -18.28%.

```{r}
barplot(as.numeric(omega_gmv), col = 'black', ylim = c(-1, 1))
```

## 2.2 Implementation of Principal Component Analysis (PCA)

Principal Component Analysis (PCA) is a technique used to analyze and reduce the dimensionality of a dataset while retaining as much variance as possible. We perform the PCA analysis using the second subsample starting from the trading day number 401 of the sample to the trading day number 1174.

```{r}
pca_result <- prcomp(subsample2, center = TRUE, scale = TRUE)

#Extract principal component loadings
loadings <- pca_result$rotation

#Variance explained by each principal component
var_explained <- (pca_result$sdev^2) / sum(pca_result$sdev^2)

#We select the number of components for the PCA
num_components <- 3  # Adjust as needed

#We compute the weights of the PCA in the portfolio.
weights_pca <- loadings[, 1:num_components] / rowSums(loadings[, 1:num_components])
```

This is the result of the plot from the PCA analysis. In the context of your PCA results for the twenty US equity stocks, here are some interpretations:

1.  **Principal Components (PCs)**:

    -   PC1, PC2, and PC3 represent the first, second, and third principal components, respectively.

    -   Each principal component is a linear combination of the original variables (in this case, stocks) such that it captures the maximum variance in the data. PC1 captures the most variance, followed by PC2, and so on.

2.  **Loadings**:

    -   Loadings represent the coefficients that define the contribution of each original variable (stock) to the principal component. The loadings are specific to each PC.

    -   Positive or negative values in loadings indicate the direction and strength of the relationship between each stock and the principal component. For example, a high positive loading indicates that a particular stock has a strong positive influence on the corresponding principal component.

3.  **Weights for the PCA Portfolio**:

    -   The weights for the PCA portfolio represent the portfolio allocation to each stock based on the chosen principal components. These weights can be used to create a portfolio with a specific strategy, which leverages the information in the principal components.

    -   In your code, you've selected the first three principal components (num_components = 3), and you've calculated the weights for each stock based on these components.

4.  **Interpretation**:

    -   PC1, PC2, and PC3 capture specific patterns or relationships in the returns of the stocks. For example, PC1 might capture broad market movements, while PC2 might capture sector-specific trends.

    -   The specific interpretation of each PC depends on the loadings and how they relate to the original variables (stocks). Positive loadings indicate stocks that move in the same direction as the principal component, while negative loadings suggest stocks that move in the opposite direction.

    -   By examining the loadings for each PC, you can gain insights into which stocks are the most influential for each component.

```{r}
my_colors <- c("red", "blue", "green") # vector of colours
barplot(weights_pca, beside = TRUE, col = my_colors,
        names.arg = colnames(weights_pca),
        legend.text = colnames(weights_pca), 
        main = "PCA Portfolio Weights")
```

# 3. Tangency portfolio and Black-Litterman approach

## 3.1 Packages

We use the following libraries:

1.  tidyverse: This package is a powerful toolbox that combines various R packages to streamline data manipulation, visualization, and analysis. It includes versatile tools like ggplot2 for visuals, dplyr for data tweaks, and tidyr for tidying data.

2.  quantmod: quantmod specializes in quantitative financial modeling and data analysis. It equips us with tools to handle financial data, perform technical analysis, and model financial time series.

3.  DataExplorer: DataExplorer aids in the initial data exploration phase. It provides quick insights through functions for generating summary statistics, visualizing missing data, and plotting variable distributions.

4.  corrplot: This package is your go-to for visualizing correlation matrices. It offers functions to create informative correlation plots, helping you grasp relationships between data variables.

5.  scales: scales complements R graphics, especially in conjunction with ggplot2. It furnishes various scales and formatting functions to customize plot aesthetics, including axes, labels, and color scales

```{r}
library(tidyverse)
library(quantmod)
library(DataExplorer)
library(corrplot)
library(scales)
```

## 3.2 Investment universe

We have carefully chosen a set of five trackers (ETFs) to represent our univestment universe. An ETF can be defined as a financial product that is based on a basket of different assets, to replicate the actual performance of each selected investment. An ETF has more or less the same proportion of the underlying components of the basket, depending on the style of management of the asset manager.

Our selection strategy is based on several fundamental considerations:

-   Investment universe: The investment universe aims at representing different asset classes in order to construct a multi-asset portfolio.

-   Diversification strategy: Our commitment to constructing a well-rounded portfolio has been affirmed through diversification across various sectors and industries. Such diversification is a critical risk management tool, curbing overexposure to a single sector or asset class.

-   Historical data availability: The selected trackers benefit from a rich repository of historical data and extensive research. The accessibility of such data enable these ETFs to rigorous portfolio management analysis and comprehensive research.

The provided R code defines the tickers for these trackers, allowing you to access the financial data. This data can then be employed to conduct a range of analyses, such as return calculations, risk assessments, and portfolio optimization, to test and implement various investment strategies.

We source our data from Yahoo Finance, a highly reputable platform renowned for its financial data. Our analysis covers a comprehensive three-and-a-half-year period, allowing us to evaluate the performance of our selected asset class both before and after the onset of the COVID-19 pandemic.

```{r}
# Define the stock tickers you want to fetch data for
stock_tickers <- c("SPY", "BNDX", "VTI", "DBC", "GLD")

# Fetch historical stock data from Yahoo Finance
start_date <- "2019-01-01"  # Replace with your desired start date
end_date <- "2023-08-31"    # Replace with your desired end date

# Use getSymbols to fetch data for all stock tickers
stock_data <- getSymbols(stock_tickers, from = start_date, to = end_date, auto.assign = TRUE)
```

## 3.3 Data cleaning

We initiate data cleaning, a crucial step in data analysis:

-   Extracting Adjusted Closing Prices: We use the lapply function to obtain adjusted closing prices, commonly used for return calculations, for a list of stock tickers. This code iterates through each ticker and fetches the adjusted closing prices.

-   Combining Stock Returns: To consolidate the adjusted closing prices, we employ cbind, creating a data frame where each column represents a specific stock's adjusted closing prices.

-   Renaming Columns: We label the columns with their corresponding stock tickers, facilitating easy identification.

-   Handling Missing Data: We remove rows with missing values from the dataset for quality and consistency.

```{r}
# Extract adjusted closing prices (which are typically used for returns)
stock_returns <- lapply(stock_tickers, function(ticker) {
  Ad(get(ticker))
})

# Combine stock returns into a single data frame
fin_prices <- do.call(cbind, stock_returns)

# Eliminate missing data in time series
fin_return <- na.omit(fin_prices)  # Remove rows with missing values

```

Arithmetic returns are used for performance assessment, offering a clear view of gains and losses, suitable for short-term analysis, and ensuring transparency.

```{r}
# Computation of returns
arith_fin_returns = diff(fin_return)/lag(fin_return)
head(arith_fin_returns, n=3)
arith_fin_returns <- arith_fin_returns[-1, ]


```

In order to ensure that the data is properly imported, with non missing valiues and proper data cleaning procedure, we can implement this line of code in order to learn more about data.

```{r}
# Data exploration for the return time series
plot_intro(arith_fin_returns)
```

We plot the rebased performance of the trackers selected in our investment universe. From the graph below, we can clearly see the outperformance of equity trackers by a considerable margin with respected to the other asset classes.

The outperformance of equity returns during the period from 2019 to 2023 can be attributed to several key factors, with a strong emphasis on the role of equity markets, particularly the US market, as the main driver of these returns. Here's a justification for this phenomenon:

-   Global economic growth: The period from 2019 to 2023 witnessed relatively strong global economic growth, with major economies recovering from the aftermath of the 2008 financial crisis. This growth provided a favorable backdrop for equity markets, as rising economic activity often correlates with higher corporate earnings.

-   Monetary policy support: Central banks, including the Federal Reserve in the United States, implemented accommodative monetary policies. Low-interest rates and quantitative easing measures aimed to stimulate economic activity and encourage investment in riskier assets like equities.

-   US equity dominance: The US equity market, represented by indices like the S&P 500, played a central role in driving global equity returns. The US market is home to a diverse range of sectors, including technology, healthcare, and consumer goods, which collectively contributed to robust earnings growth.

-   Technological advancements: The tech sector, dominated by US companies, experienced significant advancements during this period. Innovations in areas such as cloud computing, e-commerce, and digital services led to substantial revenue growth for many tech firms, lifting their stock prices.

-   Investor sentiment: Favorable investor sentiment, driven by expectations of continued economic expansion and corporate profits, played a crucial role. Positive sentiment often leads to increased capital flows into equities.

-   Sectoral performance: Certain sectors, like technology and healthcare, significantly outperformed others due to their resilience and growth prospects. The performance of these sectors, coupled with their weight in major indices, contributed to overall equity outperformance.

-   Globalization: Equity markets became more interconnected than ever, enabling investors to diversify globally. The interplay of global economic factors and cross-border investments amplified returns.

-   Risk appetite: As economic conditions improved, investors exhibited a greater appetite for risk, favoring equities over traditional safe-haven assets like bonds.

In summary, the out performance of equity returns during the 2019-2023 period can be largely attributed to a combination of global economic growth, accommodating monetary policies, technological advancements, and the dominant role of the US equity market. The US market's influence, driven by the performance of its key sectors and companies, has been a primary driver of these strong returns.

```{r}
# Calculate Cumulative Returns
cumulative_returns <- cumprod(1 + arith_fin_returns)

# Plot Cumulative Return Performance
library(ggplot2)
autoplot(cumulative_returns, facets = NULL) +
  ggtitle("Cumulative Return Performance of the investment universe") +
  ylab("Cumulative Return") +
  xlab("Year")

```

To enhance our data analysis, we can perform statistical analysis on the daily returns of each stock. This helps us evaluate their performance and behavior during the observed timeframe. Please note that the figures derived from this analysis are presented in daily returns.

```{r}
# Statistical summary of returns for each asset class

summary(arith_fin_returns)
```

In portfolio management, statistical analysis plays a key role in understanding financial data patterns. Two essential tools are density plots, which visualize data distributions, and QQ plots, used to assess data conformity to theoretical distributions. These methods assist portfolio managers in making data-driven investment decisions, enhancing the exploration of financial data, and understanding the behavior of selected equities' returns. As seen from the QQ plot, the results are not normally distributed.

```{r}
# Advanced statistical analysis for the dataset

#plot_density(arith_fin_returns)
plot_qq(arith_fin_returns)
```

Correlation is a fundamental concept related to diversification, which seeks to use poorly correlated and non correlated assets to construct a portfolio. Diversification aims to boost returns while minimizing risk by investing in assets that respond differently to various events. Prudent investors seeking risk mitigation will diversify their portfolios.

In our investment universe, opportunities for diversification arise. Defensive assets like gold (TICKER: GLD) can effectively diversify when combined with more aggressive ones. For instance, the Vanguard Total Index tracker (TICKER: VTI) has a poor correlation with gold (TICKER: GLD), and the same applies to the Vanguard Total International Bond Index tracker (TICKER: BNDX). While we don't find negative correlations in our investment universe, all assets exhibit some degree of correlation with one another.

```{r}
# Correlation analysis

library(corrplot)
corrplot( cor(arith_fin_returns), type='lower', method = "shade", tl.col = 'black', cl.pos = "r", tl.cex = 1)
```

# 4. Modelling of the portfolio

## 4.1 Implementing the Tangency portfolio (TP)

In time series data analysis, a crucial application involves splitting the dataset into training and testing sets based on temporal order. This is vital when working with data that evolves over time, such as stock prices or weather observations.

The training set consists of historical data, while the testing set contains more recent observations. This division allows analysts to assess predictive models and forecasting techniques. By training the model on historical data and evaluating it with recent data, we can determine its ability to make accurate predictions. This is especially important in finance for understanding and forecasting trends over time.

For modeling purposes, we'll create two sub-samples with defined parameters.

```{r}
# Specify the number of rows for the first subsample
num_rows_subsample1 <- 400

# Calculate the total number of rows in your dataset
total_rows <- nrow(arith_fin_returns)
```

1.  The first sub-sample will cover the first 400 trading days covered in the data set.

```{r}
# Create the first subsample
subsample1 <- arith_fin_returns[1:num_rows_subsample1, ]
plot_intro(subsample1)

```

2.  The second sub-sample will cover the rest of the data set, covering the equivalent of 773 trading days.

```{r}
# Create the second subsample by excluding the rows in the first subsample
subsample2 <- arith_fin_returns[(num_rows_subsample1 + 1):total_rows, ]
plot_intro(subsample2)
```

We implement the parameters of the model in order to compute the Tangency Portfolio:

```{r}
n <- ncol(subsample1)
T <- nrow(subsample1)
e <- rep(1, n)
perio <- 12
rf <- 0

```

The parameter sigma, representing the unbiased covariance matrix (similar to the procedure implemented when computing the GMV portfolio), can be computed using the following procedure:

```{r}
mu <- colMeans(subsample1) * perio - rf
Sigma <- cov(subsample1) * (T - 1) / (T - n - 2) * perio
A <- t(e) %*% solve(Sigma) %*% mu
omega <- 1 / as.numeric(A) * solve(Sigma) %*% mu

returns = mu %*% omega
```

In this particular context, the portfolio is characterized by its distinctive blend of investment strategies, encompassing both long and short positions. This approach signifies the allocation of the entire investment capital, with resources dedicated to assets expected to yield positive returns (long positions) and those projected to underperform (short positions). The underlying principle of this diversified strategy is to construct a well-rounded portfolio with exposure to a diverse array of asset classes.

Long Positions: The segment of the portfolio dedicated to long positions emphasizes assets anticipated to deliver favorable returns. Investors commit their capital to acquiring these assets, and notable long holdings include:

-   SPY Tracker (TICKER: SPY): Representing the SPDR S&P 500 ETF Trust, which tracks the performance of the S&P 500 index, this asset holds a significant long position of 99.48%. This allocation reflects a robust conviction in the growth potential of U.S. equities represented by the S&P 500. Vanguard Total International Bond Index Tracker (TICKER BNDX): An Exchange-Traded Fund (ETF) that mirrors international bond markets, it commands a substantial long position of 72.65%. This allocation underscores the investor's confidence in international bonds as a fundamental component of their portfolio.

-   Gold Tracker (TICKER: GLD): The portfolio also includes a noteworthy long position in gold, constituting 30.05% of the allocation. Gold is traditionally perceived as a hedge against economic uncertainties, and this allocation signifies a risk-mitigation component within the portfolio.

Short Positions: Conversely, the short segment of the portfolio is allocated to assets anticipated to exhibit weak performance. In this context, investors engage in the practice of borrowing assets to sell in the market, with the expectation that their values will decline. Prominent short positions comprise:

-   Vanguard Total Index Tracker (TICKER: VTI): The significant short position of -83.91% indicates a pessimistic outlook on this U.S. total market index ETF. The investor anticipates a decrease in the value of this asset, thereby justifying the short position.

-   (TICKER: DBC): This position is short at -18.27%. The investor assumes a bearish stance on this asset and foresees a reduction in its value.

The concept of a mixed portfolio empowers investors to diversify their exposure by capitalizing on both optimistic and pessimistic market forecasts. While long positions reflect confidence in the growth potential of specific assets, short positions signify the anticipation of declining values in those assets. This strategy enables investors to construct a balanced and diversified portfolio that optimizes the trade-off between risk and return.

Through the incorporation of both long and short positions, investors possess the potential to generate returns in a variety of market conditions, irrespective of whether they anticipate upward or downward market trends. It is essential to acknowledge that the selection of specific allocations and positions should align cohesively with the investor's overarching investment strategy and their tolerance for risk.

```{r}
# Plot of Tangency portfolio

barnames <- c("SPY", "BNDX", "VTI", "DBC", "GLD")
barplot(
  as.numeric(omega),
  col = 'Black',
  names.arg = barnames,
  ylim = c(-1, 1.5)
)
```

## 4.2 Implementing Black-Litterman approach

As described in their investment outlook (BlackRock, 2023), we can base our market outlook on the following analysis conducted by BlackRock, one of the best asset management firm worldwide. The reasoning of each outlook will help construct a assumptions on the value of our views in portfolio allocation under the Black-Litterman framework.

**US Equity Market**

-   The US stock market is facing several challenges, such as rising interest rates, slowing economic growth, and geopolitical tensions. However, the US economy remains relatively strong, and corporate profits are expected to remain healthy.

-   We believe that the US stock market is likely to be volatile in the near term. However, we remain optimistic about the long-term outlook for the US stock market.

**Global Bonds**

-   The outlook for global bonds is mixed. On the one hand, inflation is expected to remain high in the near term, which could put upward pressure on bond yields. On the other hand, economic growth is slowing, which could lead to lower bond yields.

-   Overall, we believe that the risks are skewed to the downside for global bonds. Investors should be aware of the potential for further losses in bond prices.

**International Equities**

-   International stocks have underperformed US stocks in recent years, but they are now starting to look more attractive.

-   Valuations in many international markets are relatively low, and there are signs that earnings growth is picking up.

-   However, investors will need to be aware of the risks associated with investing in international markets, such as currency fluctuations and political instability.

**Commodities**

-   Commodity prices have been volatile in recent months, but they are likely to remain supported by strong demand from China.

-   The ongoing war in Ukraine is also likely to keep commodity prices elevated.

-   However, investors should be aware that commodity prices can be cyclical, and they may not continue to rise indefinitely.

**Gold**

-   Gold prices have rallied significantly in recent months, driven by concerns about global economic growth and geopolitical tensions.

-   The outlook for gold remains positive in the near term, as investors seek out safe haven assets.

-   However, over the longer term, gold prices are likely to be more sensitive to changes in real interest rates.

In summary, BlackRock suggest the following outlook scenario for each asset class:

-   **US equities** (TICKER: SPY): Neutral

-   **Global bonds** (TICKER: BNDX): Underweight

-   **International equities** (TICKER: VTI): Neutral

-   **Commodities** (TICKER: DBC): Overweight

-   **Gold** (TICKER: GLD): Overweight

```{r}
Q <- numeric(5)
Q[1] <- 0.00 # neutral view for US equity index (SPY)
Q[2] <- -0.2 # negative view for Global bond index (BNDX)
Q[3] <- 0.00 # neutral view for global equity index (VTI)
Q[4] <- 0.03 # positive view for commodity index (DBC)
Q[5] <- 0.05 # postive view for the gold index (GLD)
tau <- 0.95
```

The Black-Litterman optimization approach is a widely-used method for improving the estimation of expected returns and making asset allocation decisions. It addresses the limitations of traditional mean-variance optimization by incorporating investor views and market equilibrium considerations. The following key steps are performed:

Mixed estimation of returns: The code starts by computing expected returns using mixed estimation. This means combining the market equilibrium-based returns (mu) with the views-based returns (Q) using a blending process. The parameter tau adjusts the strength of the blending. This approach allows investors to incorporate their subjective views on assets into the asset allocation process while considering the overall market dynamics.

Tactical allocation with views directly: This part of the code calculates the tactical asset allocation weights based on views directly. It uses a matrix A_Q and the matrix of uncertainty in views (omega_Q) to determine the optimal portfolio weights. These weights reflect the investor's views on specific assets and are adjusted according to their confidence in those views.

Tactical allocation with mixed estimation: Similarly, this part calculates tactical asset allocation weights, but this time, it uses the mixed estimation approach. It calculates A_mixed and omega_mixed based on the mixed estimation of expected returns. This allows investors to take a balanced approach, combining both market equilibrium considerations and their own views in the asset allocation process.

Black-Litterman offers a flexible framework for investors to incorporate their insights and views while maintaining a connection to market equilibrium. It's a valuable tool for optimizing portfolio allocation decisions, especially when investors have specific expectations or insights about the market.

Source [1] Black, F., & Litterman, R. B. (1992). Global portfolio optimization. Financial Analysts Journal, 48(5), 28-43.

```{r}

#Mixed estimation of returns

Omega <- diag(diag(Sigma), n, n)
mu_mixed <-
  solve(solve(tau * Sigma) + solve(Omega)) %*% (solve(tau * Sigma) %*% mu +
                                                  solve(Omega) %*% Q)

#Tactical allocation with views directly

A_Q <- t(e) %*% solve(Sigma) %*% Q
omega_Q <- 1 / as.numeric(A_Q) * solve(Sigma) %*% Q
barplot(as.numeric(omega_Q), col = 'black', names.arg = barnames, ylim = c(-0.5,1.5))


```

We can add the following comments on the new portfolio allocation under Black-Litterman approach, including asset views.

-   **SPY.Adjusted (-3.62%)**: The adjustment in SPY's weighting is intriguing. The new allocation of -3.62% suggests a significant shift from a previous long position to a short position. This reflects a bearish outlook on the S&P 500 and U.S. equities. The investor is positioned to potentially benefit from a decrease in the S&P 500's performance, indicating a degree of concern or pessimism about the market's short-term prospects.

-   **BNDX.Adjusted (110.34%)**: The allocation to BNDX has surged, reaching 110.34%. This remarkable increase implies a robust bullish stance on international bonds. The investor appears confident in the performance of international bond markets, seeking to capitalize on potential gains in this asset class. The elevated allocation underlines their belief in the stability and growth potential of international bonds.

-   **VTI.Adjusted (1.64%)**: VTI's allocation has seen a more modest change, settling at 1.64%. This allocation suggests a relatively neutral view on the U.S. total market index ETF. The investor anticipates steady or moderate returns from VTI, which is reflected in the conservative weighting. It's indicative of a balanced perspective without a strong bullish or bearish bias.

-   **DBC.Adjusted (0.40%)**: DBC's allocation has undergone a slight adjustment, reaching 0.40%. This allocation indicates a conservative stance on commodities. The investor may have a modestly bullish or relatively neutral view on this asset class, given the small allocation. It implies expectations of limited market movements or a potential modest uptrend in commodity prices.

-   **GLD.Adjusted (-7.95%)**: The weighting for GLD has decreased to -7.95%. This reduction suggests a bearish stance on gold, which is often considered a safe-haven asset. The negative allocation indicates a degree of skepticism or a view that the economic environment may not necessitate extensive holdings in this precious metal. It reflects a potential decrease in gold's value, which aligns with a risk-on sentiment in the portfolio.

Incorporating views into the portfolio has resulted in diverse adjustments across asset classes, reflecting the investor's evolving outlook on each. These changes are indicative of a dynamic strategy that aims to capitalize on various market scenarios. It's crucial to consider these allocations within the context of the investor's overall investment objectives and risk tolerance, as they play a pivotal role in shaping the portfolio's risk-return profile.

```{r}
#Tactical allocation with mixed estimation
A_mixed <- t(e) %*% solve(Sigma) %*% mu_mixed
omega_mixed <- 1 / as.numeric(A_mixed) * solve(Sigma) %*% mu_mixed
barplot(as.numeric(omega_mixed), col = 'black', names.arg = barnames, ylim = c(-0.5,1.5))
```
