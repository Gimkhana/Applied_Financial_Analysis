---
title: "Tangency portfolio and Black-Litterman approach"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  markdown: 
    wrap: 72
---

# 3. Introduction

## 3.1 Packages

We use the same packages as described on 1.1.

```{r packages part 2, include=FALSE}
library(tidyverse)
library(quantmod)
library(DataExplorer)
library(corrplot)
library(scales)
```

## 3.2 Investment universe

We have carefully chosen a set of five trackers (ETFs) to represent our
univestment universe. An ETF can be defined as a financial product that
is based on a basket of different assets, to replicate the actual
performance of each selected investment. An ETF has more or less the
same proportion of the underlying components of the basket, depending on
the style of management of the asset manager.

Our selection strategy is based on several fundamental considerations:

-   Investment universe: The investment universe aims at representing
    different asset classes in order to construct a multi-asset
    portfolio.

-   Diversification strategy: Our commitment to constructing a
    well-rounded portfolio has been affirmed through diversification
    across various sectors and industries. Such diversification is a
    critical risk management tool, curbing overexposure to a single
    sector or asset class.

-   Historical data availability: The selected trackers benefit from a
    rich repository of historical data and extensive research. The
    accessibility of such data enable these ETFs to rigorous portfolio
    management analysis and comprehensive research.

The provided R code defines the tickers for these trackers, allowing you
to access the financial data. This data can then be employed to conduct
a range of analyses, such as return calculations, risk assessments, and
portfolio optimization, to test and implement various investment
strategies.

We source our data from Yahoo Finance, a highly reputable platform
renowned for its financial data. Our analysis covers a comprehensive
three-and-a-half-year period, allowing us to evaluate the performance of
our selected asset class both before and after the onset of the COVID-19
pandemic.

```{r Investment universe data extraction, include=FALSE}
# Define the stock tickers you want to fetch data for
stock_tickers <- c("VTI", "EMGF", "IEF", "DBC", "GLD")

# Fetch historical stock data from Yahoo Finance
start_date <- "2019-01-01"  # Replace with your desired start date
end_date <- "2023-08-31"    # Replace with your desired end date

# Use getSymbols to fetch data for all stock tickers
stock_data <- getSymbols(stock_tickers, from = start_date, to = end_date, auto.assign = TRUE)
```

## 3.3 Data cleaning

We initiate data cleaning, a crucial step in data analysis:

-   Extracting Adjusted Closing Prices: We use the lapply function to
    obtain adjusted closing prices, commonly used for return
    calculations, for a list of stock tickers. This code iterates
    through each ticker and fetches the adjusted closing prices.

-   Combining Stock Returns: To consolidate the adjusted closing prices,
    we employ cbind, creating a data frame where each column represents
    a specific stock's adjusted closing prices.

-   Renaming Columns: We label the columns with their corresponding
    stock tickers, facilitating easy identification.

-   Handling Missing Data: We remove rows with missing values from the
    dataset for quality and consistency.

We initiate data cleaning, a crucial step in data analysis:

-   **Extracting adjusted closing prices:** We use the lapply function
    to obtain adjusted closing prices, commonly used for return
    calculations, for a list of stock tickers. This code iterates
    through each ticker and fetches the adjusted closing prices.

-   **Combining stock returns:** To consolidate the adjusted closing
    prices, we employ cbind, creating a data frame where each column
    represents a specific stock's adjusted closing prices.

-   **Renaming columns:** We label the columns with their corresponding
    stock tickers, facilitating easy identification.

-   **Handling missing data:** We remove rows with missing values from
    the dataset for quality and consistency.

```{r Return calculations, include=FALSE}
# Extract adjusted closing prices (which are typically used for returns)
stock_returns <- lapply(stock_tickers, function(ticker) {
  to.monthly(Ad(get(ticker)), indexAt = 'lastof', OHLC = FALSE)
})

# Combine stock returns into a single data frame
fin_prices <- do.call(cbind, stock_returns)

# Eliminate missing data in time series
fin_return <- na.omit(fin_prices)  # Remove rows with missing values

```

Arithmetic returns are used for performance assessment, offering a clear
view of gains and losses, suitable for short-term analysis, and ensuring
transparency.

```{r Arithmetic returns, include=FALSE}
# Computation of returns
arith_fin_returns = diff(fin_return)/lag(fin_return)
head(arith_fin_returns, n=3)
arith_fin_returns <- arith_fin_returns[-1, ]

```

In order to ensure that the data is properly imported, with non missing
values and proper data cleaning procedure, we can implement this line of
code in order to learn more about data.

```{r Data exploration multi-asset, echo=FALSE}
# Data exploration for the return time series
plot_intro(arith_fin_returns)
```

We plot the rebased performance of the trackers selected in our
investment universe. From the graph below, we can clearly see the
outperformance of equity trackers by a considerable margin with
respected to the other asset classes.

The outperformance of equity returns during the period from 2019 to 2023
can be attributed to several key factors, with a strong emphasis on the
role of equity markets, particularly the US market, as the main driver
of these returns. Here's a justification for this phenomenon:

-   Global economic growth: The period from 2019 to 2023 witnessed
    relatively strong global economic growth, with major economies
    recovering from the aftermath of the 2008 financial crisis. This
    growth provided a favorable backdrop for equity markets, as rising
    economic activity often correlates with higher corporate earnings.

-   Monetary policy support: Central banks, including the Federal
    Reserve in the United States, implemented accommodative monetary
    policies. Low-interest rates and quantitative easing measures aimed
    to stimulate economic activity and encourage investment in riskier
    assets like equities.

-   US equity dominance: The US equity market, represented by indices
    like the S&P 500, played a central role in driving global equity
    returns. The US market is home to a diverse range of sectors,
    including technology, healthcare, and consumer goods, which
    collectively contributed to robust earnings growth.

-   Technological advancements: The tech sector, dominated by US
    companies, experienced significant advancements during this period.
    Innovations in areas such as cloud computing, e-commerce, and
    digital services led to substantial revenue growth for many tech
    firms, lifting their stock prices.

-   Investor sentiment: Favorable investor sentiment, driven by
    expectations of continued economic expansion and corporate profits,
    played a crucial role. Positive sentiment often leads to increased
    capital flows into equities.

-   Sectoral performance: Certain sectors, like technology and
    healthcare, significantly outperformed others due to their
    resilience and growth prospects. The performance of these sectors,
    coupled with their weight in major indices, contributed to overall
    equity outperformance.

-   Globalization: Equity markets became more interconnected than ever,
    enabling investors to diversify globally. The interplay of global
    economic factors and cross-border investments amplified returns.

-   Risk appetite: As economic conditions improved, investors exhibited
    a greater appetite for risk, favoring equities over traditional
    safe-haven assets like bonds.

In summary, the out performance of equity returns during the 2019-2023
period can be largely attributed to a combination of global economic
growth, accommodating monetary policies, technological advancements, and
the dominant role of the US equity market. The US market's influence,
driven by the performance of its key sectors and companies, has been a
primary driver of these strong returns.

```{r echo=FALSE}
# Calculate Cumulative Returns
cumulative_returns <- cumprod(1 + arith_fin_returns)

# Plot Cumulative Return Performance
library(ggplot2)
autoplot(cumulative_returns, facets = NULL) +
  ggtitle("Cumulative Return Performance of the investment universe") +
  ylab("Cumulative Return") +
  xlab("Year")

```

To enhance our data analysis, we can perform statistical analysis on the
daily returns of each stock. This helps us evaluate their performance
and behavior during the observed timeframe. Please note that the figures
derived from this analysis are presented in daily returns.

```{r include=FALSE}
# Statistical summary of returns for each asset class

summary(arith_fin_returns)
```

In portfolio management, statistical analysis plays a key role in
understanding financial data patterns. Two essential tools are density
plots, which visualize data distributions, and QQ plots, used to assess
data conformity to theoretical distributions. These methods assist
portfolio managers in making data-driven investment decisions, enhancing
the exploration of financial data, and understanding the behavior of
selected equities' returns. As seen from the QQ plot, the results are
not normally distributed.

```{r}
# Advanced statistical analysis for the dataset

#plot_density(arith_fin_returns)
plot_qq(arith_fin_returns)
```

Correlation is a fundamental concept related to diversification, which
seeks to use poorly correlated and non correlated assets to construct a
portfolio. Diversification aims to boost returns while minimizing risk
by investing in assets that respond differently to various events.
Prudent investors seeking risk mitigation will diversify their
portfolios.

In our investment universe, opportunities for diversification arise.
Defensive assets like gold (TICKER: GLD) can effectively diversify when
combined with more aggressive ones. For instance, the Vanguard Total
Index tracker (TICKER: VTI) has a poor correlation with gold (TICKER:
GLD), and the same applies to the Vanguard Total International Bond
Index tracker (TICKER: BNDX). While we don't find negative correlations
in our investment universe, all assets exhibit some degree of
correlation with one another.

```{r}
# Correlation analysis

library(corrplot)
corrplot( cor(arith_fin_returns), type='lower', method = "shade", tl.col = 'black', cl.pos = "r", tl.cex = 1)
```

# 4. Modelling of the portfolio

## 4.1 Implementing the Tangency portfolio (TP)

In time series data analysis, a crucial application involves splitting
the dataset into training and testing sets based on temporal order. This
is vital when working with data that evolves over time, such as stock
prices or weather observations.

The training set consists of historical data, while the testing set
contains more recent observations. This division allows analysts to
assess predictive models and forecasting techniques. By training the
model on historical data and evaluating it with recent data, we can
determine its ability to make accurate predictions. This is especially
important in finance for understanding and forecasting trends over time.

The training set consists of historical data, while the testing set
contains more recent observations. This division allows analysts to
assess predictive models and forecasting techniques. By training the
model on historical data and evaluating it with recent data, we can
determine its ability to make accurate predictions. This is especially
important in finance for understanding and forecasting trends over time.

For modeling purposes, we'll create two sub-samples with defined
parameters.

```{r Subsampling multi-asset portfolio, echo=FALSE}
# Specify the number of rows for the first subsample
num_rows_subsample1 <- 20

# Calculate the total number of rows in your dataset
total_rows <- nrow(arith_fin_returns)
```

1.  The first sub-sample will cover the first 20 trading month covered
    in the data set.

```{r Subsample 1 multi-asset portfolio, echo=FALSE}
# Create the first subsample
subsample1 <- arith_fin_returns[1:num_rows_subsample1, ]
plot_intro(subsample1)

```

2.  The second sub-sample will cover the rest of the data set, covering
    the equivalent of 36 trading months.

```{r Subsample 2 multi-asset portfolio, echo=FALSE}
# Create the second subsample by excluding the rows in the first subsample
subsample2 <- arith_fin_returns[(num_rows_subsample1 + 1):total_rows, ]
plot_intro(subsample2)
```

We implement the parameters of the model in order to compute the
Tangency Portfolio:

```{r parameters of model, include=FALSE}
n <- ncol(subsample1)
T <- nrow(subsample1)
e <- rep(1, n)
perio <- 12
rf <- 0

```

The parameter sigma, representing the unbiased covariance matrix
(similar to the procedure implemented when computing the GMV portfolio),
can be computed using the following procedure:

```{r unbiased covariance matrix, include=FALSE}
mu <- colMeans(subsample1) * perio - rf
Sigma <- cov(subsample1) * (T - 1) / (T - n - 2) * perio
A <- t(e) %*% solve(Sigma) %*% mu
omega <- 1 / as.numeric(A) * solve(Sigma) %*% mu

returns = mu %*% omega
```

The portfolio allocation consists of both long positions, where
investors expect favorable returns, and short positions, where they
anticipate weaker performance. Here's a more detailed explanation of
each asset class allocation:

Long Positions:

-   **International Equities (Ticker: VTI, Allocation: 17.54%):** This
    segment of the portfolio is dedicated to international equities,
    with VTI making up 17.54% of the overall portfolio. Investors are
    optimistic about the performance of international equities, which is
    why they have allocated a significant portion of their capital to
    this asset class.

-   **US Short-Term Maturity Bond (Ticker: IEF, Allocation: 88.91%):**
    The largest allocation in the long positions is in US short-term
    maturity bonds, represented by IEF. This allocation indicates a
    strong conviction in the stability and income potential of
    short-term bonds.

-   **Emerging Markets (Ticker: EMGF, Allocation: 5.7%):** In the case
    of emerging markets, the allocation is bullish at 5.7%. This
    indicates that investors are taking a positive stance on the
    performance of emerging market assets, expecting their values to
    rise.

-   **Commodities (Ticker: DBC, Allocation: 0.06%):** The allocation to
    commodities, represented by DBC, is even more conservative at 0.06%.
    This suggests a neutral outlook on commodities, which reflects a
    cautious approach towards commodities in the portfolio.

Short Positions: The short segment of the portfolio is allocated to
assets where weak performance is expected.

-   **Gold (Ticker: GLD, Allocation: -12.83%):** Gold is often
    considered a safe-haven asset, and this allocation suggests that
    investors still see value in holding gold as a hedge or store of
    value, albeit at a slightly reduced allocation.

In summary, the portfolio is strategically balanced between long
positions, where investors have confidence in the assets' growth
potential, and short positions, where they are expecting weaker
performance. The specific allocations provide insights into the level of
conviction and sentiment regarding each asset class.

```{r Plot tangency portoflio, echo=FALSE}
# Plot of Tangency portfolio

barnames <- c("VTI", "EMGF", "IEF", "DBC", "GLD")
barplot(
  as.numeric(omega),
  col = 'Black',
  names.arg = barnames,
  ylim = c(-0.5, 1)
)
```

## 4.2 Implementing Black-Litterman approach

This investment universe is designed to provide diversified exposure
across a range of asset classes, including broad market indices,
emerging market equities, government bonds, commodities, and precious
metals. This selection is intended to balance risk and return while
capturing growth opportunities and providing a hedge against inflation.

-   VTI (Vanguard Total Stock Market ETF): Broad exposure to the global
    stock market.

-   EMGF (iShares MSCI Emerging Markets Multifactor ETF): Exposure to
    emerging markets with favorable exposure to value, quality,
    momentum, and size factors.

-   IEF (iShares 7-10 Year Treasury Bond ETF): Exposure to
    intermediate-term government bonds.

-   DBC (Invesco DB Commodity Index Tracking Fund): Exposure to a basket
    of commodities.

-   GLD (SPDR Gold Trust): Exposure to gold.

### **2.2.2 Economic data:**

To connect our investment universe selection to the asset allocation, we
can refer to market outlooks from the prominent Wall Street most
reliable market commentaries. We take the economic data from Goldman
Sachs Asset Management, BlackRock, and JPMorgan Asset Management:

**BlackRock Market Outlook 2023:**

-   Global GDP growth: +3.1%

-   US GDP growth: +2.3%

-   Eurozone GDP growth: +2.1%

-   China GDP growth: +5.3% S&P 500 earnings: +10%

-   US 10-year Treasury yield: 3.3%

**Goldman Sachs Asset Management Market Outlook 2023:**

-   Global GDP growth: +2.8%

-   US GDP growth: +1.8%

-   Eurozone GDP growth: +0.6%

-   China GDP growth: +5.0%

-   S&P 500 earnings: +6%

-   US 10-year Treasury yield: 3.5%

**JPMorgan Asset Management Mid-Year Investment Outlook 2023:**

-   Global GDP growth: +3.2%

-   US GDP growth: +2.0%

-   Eurozone GDP growth: +2.0%

-   China GDP growth: +5.2%

-   S&P 500 earnings: +8%

-   US 10-year Treasury yield: 3.0%

The three financial institutions anticipate +3.0% GDP growth globally, +2.0% GDP growth in the US, and +8% earnings growth for the S&P 500 in 2023. They also predict that the rate on the US 10-year Treasury will hit 3.3%.

Goldman Sachs Asset Management is the most overweight of the three organizations when it comes to asset allocation, with an excess of equities.
In terms of bonds, they are likewise underweight, with JPMorgan Asset Management being the most so.

Despite the anticipated slowdown in economic growth, the market outlooks from these three financial institutions generally imply that stocks will remain the favored asset class in 2023. To lower risk, investors can think about diversifying their holdings by including assets like bonds and commodities.

This investment universe is a good option for investors who are looking for a diversified portfolio that offers the potential for both growth and income. The assets in this universe are supported by economic data, market outlook, and investment considerations.

Our matrix view is structured as follows: 

-   **US equities** (TICKER: SPY): Neutral

-   **Global bonds** (TICKER: BNDX): Underweight

-   **International equities** (TICKER: VTI): Neutral

-   **Commodities** (TICKER: DBC): Overweight

-   **Gold** (TICKER: GLD): Overweight

```{r}
Q <- numeric(5)
Q[1] <- 0.00 # neutral view for US equity index (SPY)
Q[2] <- -0.2 # negative view for Global bond index (BNDX)
Q[3] <- 0.00 # neutral view for global equity index (VTI)
Q[4] <- 0.03 # positive view for commodity index (DBC)
Q[5] <- 0.05 # postive view for the gold index (GLD)
tau <- 0.95
```

The Black-Litterman optimization approach is a widely-used method for
improving the estimation of expected returns and making asset allocation
decisions. It addresses the limitations of traditional mean-variance
optimization by incorporating investor views and market equilibrium
considerations. The following key steps are performed:

Mixed estimation of returns: The code starts by computing expected
returns using mixed estimation. This means combining the market
equilibrium-based returns (mu) with the views-based returns (Q) using a
blending process. The parameter tau adjusts the strength of the
blending. This approach allows investors to incorporate their subjective
views on assets into the asset allocation process while considering the
overall market dynamics.

Tactical allocation with views directly: This part of the code
calculates the tactical asset allocation weights based on views
directly. It uses a matrix A_Q and the matrix of uncertainty in views
(omega_Q) to determine the optimal portfolio weights. These weights
reflect the investor's views on specific assets and are adjusted
according to their confidence in those views.

Tactical allocation with mixed estimation: Similarly, this part
calculates tactical asset allocation weights, but this time, it uses the
mixed estimation approach. It calculates A_mixed and omega_mixed based
on the mixed estimation of expected returns. This allows investors to
take a balanced approach, combining both market equilibrium
considerations and their own views in the asset allocation process.

Black-Litterman offers a flexible framework for investors to incorporate
their insights and views while maintaining a connection to market
equilibrium. It's a valuable tool for optimizing portfolio allocation
decisions, especially when investors have specific expectations or
insights about the market.

Source [1] Black, F., & Litterman, R. B. (1992). Global portfolio
optimization. Financial Analysts Journal, 48(5), 28-43.

```{r}

#Mixed estimation of returns

Omega <- diag(diag(Sigma), n, n)
mu_mixed <-
  solve(solve(tau * Sigma) + solve(Omega)) %*% (solve(tau * Sigma) %*% mu +
                                                  solve(Omega) %*% Q)

#Tactical allocation with views directly

A_Q <- t(e) %*% solve(Sigma) %*% Q
omega_Q <- 1 / as.numeric(A_Q) * solve(Sigma) %*% Q
barplot(as.numeric(omega_Q), col = 'black', names.arg = barnames, ylim = c(-0.5,1.5))


```

We can add the following comments on the new portfolio allocation under
Black-Litterman approach, including asset views.

-   **SPY.Adjusted (-3.62%)**: The adjustment in SPY's weighting is
    intriguing. The new allocation of -3.62% suggests a significant
    shift from a previous long position to a short position. This
    reflects a bearish outlook on the S&P 500 and U.S. equities. The
    investor is positioned to potentially benefit from a decrease in the
    S&P 500's performance, indicating a degree of concern or pessimism
    about the market's short-term prospects.

-   **BNDX.Adjusted (110.34%)**: The allocation to BNDX has surged,
    reaching 110.34%. This remarkable increase implies a robust bullish
    stance on international bonds. The investor appears confident in the
    performance of international bond markets, seeking to capitalize on
    potential gains in this asset class. The elevated allocation
    underlines their belief in the stability and growth potential of
    international bonds.

-   **VTI.Adjusted (1.64%)**: VTI's allocation has seen a more modest
    change, settling at 1.64%. This allocation suggests a relatively
    neutral view on the U.S. total market index ETF. The investor
    anticipates steady or moderate returns from VTI, which is reflected
    in the conservative weighting. It's indicative of a balanced
    perspective without a strong bullish or bearish bias.

-   **DBC.Adjusted (0.40%)**: DBC's allocation has undergone a slight
    adjustment, reaching 0.40%. This allocation indicates a conservative
    stance on commodities. The investor may have a modestly bullish or
    relatively neutral view on this asset class, given the small
    allocation. It implies expectations of limited market movements or a
    potential modest uptrend in commodity prices.

-   **GLD.Adjusted (-7.95%)**: The weighting for GLD has decreased to
    -7.95%. This reduction suggests a bearish stance on gold, which is
    often considered a safe-haven asset. The negative allocation
    indicates a degree of skepticism or a view that the economic
    environment may not necessitate extensive holdings in this precious
    metal. It reflects a potential decrease in gold's value, which
    aligns with a risk-on sentiment in the portfolio.

Incorporating views into the portfolio has resulted in diverse
adjustments across asset classes, reflecting the investor's evolving
outlook on each. These changes are indicative of a dynamic strategy that
aims to capitalize on various market scenarios. It's crucial to consider
these allocations within the context of the investor's overall
investment objectives and risk tolerance, as they play a pivotal role in
shaping the portfolio's risk-return profile.

```{r}
#Tactical allocation with mixed estimation
A_mixed <- t(e) %*% solve(Sigma) %*% mu_mixed
omega_mixed <- 1 / as.numeric(A_mixed) * solve(Sigma) %*% mu_mixed
barplot(as.numeric(omega_mixed), col = 'black', names.arg = barnames, ylim = c(-0.5,1.5))
```
