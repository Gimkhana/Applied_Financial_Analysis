---
title: "Asset Management GRA (Pierre Clauss): R Markdown project"
author: "Nadezhda Dobreva (20235059@etud.univ-evry.fr) and Youssef Louraoui (20230348@etud.univ-evry.fr)"
output:
  pdf_document: default
  html_document: default
date: "`r Sys.Date()`"
editor_options:
  markdown:
    wrap: 72
---

# 1. Global Minimum Volatility portfolio (GMV) on an Equity Portfolio

## 1.1 Packages

We import the necessary libraries to perform the first analysis.

1.  **library(tidyverse):** The tidyverse package constitutes a
    collection of R packages meticulously designed to work seamlessly in
    unison for data manipulation, visualization, and analysis. It
    encompasses packages like ggplot2 for data visualization, dplyr for
    data manipulation, tidyr for data tidying, and more. Loading
    tidyverse avails all these packages for utilization during your R
    session, streamlining your data analysis workflow.

2.  **library(quantmod):** The quantmod package primarily caters to
    quantitative financial modeling and analysis. It furnishes an array
    of functions and tools for handling financial data, such as
    downloading and managing stock price data, conducting technical
    analysis, and modeling financial time series.

3.  **library(DataExplorer):** The DataExplorer package serves the
    purpose of preliminary data exploration and analysis. It offers
    functions to generate summary statistics, visualize missing data,
    plot variable distributions, and more. It can aid in obtaining a
    quick overview of your data before delving into more extensive
    analyses.

4.  **library(corrplot):** The corrplot package specializes in
    visualizing correlation matrices. It provides functions for
    generating visually appealing and informative correlation plots,
    which prove valuable for comprehending relationships between
    variables within your data.

5.  **library(scales):** The scales package provides an assortment of
    scales and formatting functions tailored for R graphics. It is often
    employed in conjunction with other plotting packages, such as
    ggplot2, to customize the appearance of plots, including axes,
    labels, and color scales.

```{r Packages, include=FALSE}
library(tidyverse)
library(quantmod)
library(DataExplorer)
library(corrplot)
library(scales)
```

## 1.2 Investment universe

### **1.2.1 Investment Universe**

In our portfolio management project, we have carefully chosen a set of
ten stocks from a larger universe of investments. This selection
represents the most significant companies in the US equity market,
primarily based on their market capitalization. By analyzing these
stocks, our objective is to gain valuable insights into the strategies
that can be employed for managing investments in the US equity market.

Our investment universe comprises a selection of ten high-performing and
influential companies, primarily from the technology sector. These
companies are recognized for their robust market capitalization,
innovative business models, and significant impact on global markets.

| Ticker | Company Description                                                                                                    |
|---------------------|---------------------------------------------------|
| AAPL   | A leader in consumer electronics, software, and services.                                                              |
| MSFT   | A global leader in software, services, devices, and solutions.                                                         |
| GOOGL  | The parent company of Google, known for its dominant search engine and a wide array of internet services and products. |
| AMZN   | A powerhouse in e-commerce, cloud computing, and artificial intelligence.                                              |
| TSLA   | An innovative company in electric vehicles, energy storage, and solar products.                                        |
| NVDA   | A pioneer in graphics processing units (GPUs) for gaming and professional markets.                                     |
| PYPL   | A leading technology platform and digital payments company.                                                            |
| CMCSA  | A global media and technology company with two primary businesses, Comcast Cable and NBCUniversal.                     |
| ADBE   | A leader in multimedia and creativity software products.                                                               |
| ASML   | A leading supplier to the semiconductor industry.                                                                      |

### **1.2.2 Market outlook and link to portfolio allocation**

According to a recent survey of Wall Street analysts commented on
Bloomberg, the median forecast for the S&P 500 index in 2023 is 4,300.
Analysts are generally bullish on the US equity market in 2023, citing
factors such as continued economic growth, strong corporate earnings,
and low interest rates. However, they also acknowledge that there are
some risks to the outlook, such as the potential for a recession and
higher inflation. Here a market outlook for each stock selected in our
investment universe.

| Ticker | Company Description                                                                                                                                                            |
|----------------------|--------------------------------------------------|
| AAPL   | The company has a strong track record of innovation. Expected to benefit from the continued growth of the smartphone market and the launch of new products and services.       |
| MSFT   | Has a diversified business model. Expected to benefit from the growth of cloud computing and other enterprise software markets.                                                |
| GOOGL  | A leader in online advertising and cloud computing. Expected to benefit from the continued growth of the digital economy.                                                      |
| AMZN   | A leader in cloud computing and e-commerce. Expected to benefit from the continued growth of online shopping and cloud computing.                                              |
| TSLA   | Expected to benefit from the growing demand for electric vehicles and the transition to clean energy.                                                                          |
| NVDA   | GPUs are used in various applications like gaming, AI, and data center computing. Expected to benefit from the growth of these markets.                                        |
| PYPL   | Expected to benefit from the growth of e-commerce and digital payments.                                                                                                        |
| CMCSA  | Expected to benefit from the continued growth of broadband internet and the rollout of new streaming services.                                                                 |
| ADBE   | Products are used by a wide range of customers. Expected to benefit from the growth of the digital economy and demand for creative software.                                   |
| ASML   | Expected to grow, driven by the semiconductor industry's growth. The only company to manufacture EUV lithography systems, well-positioned to benefit from the industry growth. |

### **1.2.3 Rationale for this investment universe selection**

The rationale behind this selection lies in diversification across
various dimensions, including market capitalization, geographical
presence, and revenue streams, while maintaining a focus on growth and
innovation. The intent is to capture both the stability of established
companies and the growth potential of market leaders and innovators. In
this sense, the choice of stocks is guided by several key
considerations:

-   **Investment universe:** Our selection is drawn from a universe of
    stocks that encompasses ten well-established companies within the US
    equity market. These companies are known for their substantial
    market presence and are recognized leaders in their respective
    industries.

-   **Market capitalization focus:** We have chosen stocks with an
    emphasis on market capitalization. Larger market capitalization
    often indicates stability and lower volatility, making these stocks
    appealing for various investment strategies.

-   **US equity market perspective:** Our project primarily targets
    insights related to the US equity market. The chosen stocks provide
    a representative snapshot of the investment landscape in one of the
    world's largest and most influential equity markets.

-   **Diversification:** To create a well-rounded portfolio, we have
    ensured diversification across different sectors and industries.
    Diversification is essential in portfolio management as it spreads
    risk and mitigates overexposure to a single sector.

-   **Market visibility:** The selected companies are not only
    well-regarded in the financial sector but are also widely recognized
    in popular culture. Their performance is closely monitored, and they
    often hold significant sway over market indices.

-   **Historical data and research:** These stocks have a rich history
    of performance data and have been the subject of extensive research.
    Access to their historical data is abundant, making them suitable
    for rigorous portfolio management analysis and research.

The provided R code defines the stock tickers for these companies,
allowing you to access financial data. This data can then be employed to
conduct a range of analyses, such as return calculations, risk
assessments, and portfolio optimization, to test and implement various
investment strategies on the US equity market.

```{r Ticker import, echo=FALSE}
# Define the stock tickers you want to fetch data for
stock_tickers <- c("AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "NVDA", "PYPL", "CMCSA", "ADBE", "ASML")
```

We source our data from Yahoo Finance, a highly reputable platform
renowned for its financial data. Our analysis covers a comprehensive
three-and-a-half-year period, allowing us to evaluate the performance of
our selected companies both before and after the onset of the COVID-19
pandemic.The start date is from 01/01/2019 to 31/08/2023.

```{r Yahoo Finance extraction data, echo=FALSE}
# Fetch historical stock data from Yahoo Finance
start_date <- "2019-01-01"  # Replace with your desired start date
end_date <- "2023-08-31"    # Replace with your desired end date
stock_data <- getSymbols(stock_tickers, from = start_date, to = end_date, auto.assign = TRUE)
```

## 1.3 Data cleaning and analysis

### 1.3.1 Data cleaning

We perform some formatting to clean the data, an important step in
performing data analysis:

-   **Extracting adjusted closing prices** (lapply(stock_tickers,
    function(ticker) { Ad(get(ticker)) })): This code uses the lapply
    function to retrieve the adjusted closing prices (often used for
    return calculations) for a list of stock tickers. It iterates
    through each ticker in the stock_tickers vector and fetches the
    adjusted closing prices using the Ad() function from the quantmod
    package.

-   **Combining stock returns** (do.call(cbind, stock_returns)): The
    code combines the extracted adjusted closing prices into a single
    data frame by calling cbind (column-bind) on the list of stock
    returns obtained in the previous step. This creates a data frame
    where each column represents the adjusted closing prices of a
    specific stock.

-   **Renaming columns** (colnames(fin_prices) \<- stock_tickers): The
    code assigns the stock tickers as column names to the combined data
    frame. This step ensures that each column is labeled with the
    corresponding stock ticker, making it easier to identify each
    stock's data.

-   **Handling missing data** (na.omit(fin_prices)): This line of code
    removes rows with missing values (usually represented as NA) from
    the combined data frame, fin_prices. Removing missing data is a
    common processing step to ensure the quality and consistency of the
    dataset for further analysis.

```{r Stock return calculation, echo=FALSE}
# Extract adjusted closing prices (which are typically used for returns)
stock_returns <- lapply(stock_tickers, function(ticker) {
  to.monthly(Ad(get(ticker)), indexAt = 'lastof', OHLC = FALSE)
})

# Combine stock returns into a single data frame
fin_prices <- do.call(cbind, stock_returns)

# Rename columns to match your analysis
colnames(fin_prices) <- stock_tickers

# Eliminated missing data in time series
fin_return <- na.omit(fin_prices)  # Remove rows with missing values
```

We perform the arithmetic return method to compute returns for this data
set. It is simple, intuitive and widely accessible. Arithmetic returns
are particularly useful for performance measurement, providing a clear
view of actual gains and losses. It is well-suited for short-term
analysis and offer transparency.

```{r Return calculation, include=FALSE}
arith_fin_returns = diff(fin_return)/lag(fin_return)
head(arith_fin_returns, n=3)
arith_fin_returns <- arith_fin_returns[-1, ]
```

In order to ensure that the data is properly imported, with non missing
values and proper data cleaning procedure, we can implement this line of
code in order to learn more about data.

```{r Plot of data structure, fig.cap="Data structure analysis of the extracted prices.", echo=FALSE, fig.pos='H', include=FALSE}
plot_intro(arith_fin_returns)
```

### 1.3.2 Data analysis

The US stock market has performed strongly from 2019 to 2023, despite
some headwinds. The S&P 500 index has returned double digit returns
during this period, driven by a number of factors, including:

-   **Strong economic growth:** The US economy grew at an average rate
    of 2.3% from 2019 to 2022, which supported corporate earnings
    growth.

-   **Low interest rates:** The Federal Reserve kept interest rates at
    record lows during this period, which boosted corporate profits and
    made stocks more attractive to investors.

-   **Government stimulus:** The US government injected a number of
    stimulus measures in response to the COVID-19 pandemic, which
    boosted consumer spending and supported the economy.

The main market movers during this period have been technology stocks,
which have outperformed other sectors by a wide margin. This is due to
the fact that technology companies have benefited from the shift to
online shopping and working during the pandemic.

Other sectors that have performed well during this period include
healthcare, consumer staples, and financials. These sectors are
generally seen as more defensive, and they have tended to outperform in
times of market volatility (Fabozzi, 2014).

Some of the top performing US stocks from 2019 to 2023 include NVIDIA
(TICKER: NVDA), Tesla (TICKER: TSLA), Apple (TICKER: AAPL), Microsoft
(TICKER: MSFT), Alphabet (TICKER: GOOGL) and Amazon (TICKER: AMZN).

These companies have all benefited from the trends mentioned above, and
they have seen their share prices rise significantly during this period.
Overall, the US stock market has performed strongly from 2019 to 2023,
despite some headwinds. The main market movers have been technology
stocks, which have outperformed other sectors by a wide margin.

From the figure below, Nvidia (TICKER: NVDA) and Tesla (TICKER: TSLA)
stock shares witnessed an unprecedented surge in attraction, making it a
notable standout within our investment universe. Tesla was among the
best performing stocks in the broader investment universe selected. The
surge in retail trading interest for the electric car company can
explain to some extent this massive performance, especially in the wake
of the post-COVID market, where intensive monetary policies prompted
significant investments from both corporate and retail investors seeking
higher yields.

Regarding Nvidia's stock price, it has surged in recent years as
investors have become increasingly bullish on the company's prospects.
There are a number of reasons for this, including:

-   **The growth of AI:** AI is one of the most important technological
    trends of our time, and Nvidia's GPUs are essential for many AI
    applications. As AI continues to grow, Nvidia is well-positioned to
    benefit.

-   **The rise of the metaverse:** The metaverse is a virtual world that
    is still in its early stages of development, but it has the
    potential to be a massive market. Nvidia's GPUs are used to power
    many of the technologies that will be used in the metaverse, such as
    virtual reality and augmented reality.

-   **Nvidia's strong financial performance:** Nvidia has been
    delivering strong financial performance for many years. In the most
    recent quarter, the company reported revenue of \$8.29 billion and
    earnings per share of \$1.32, both of which beat analyst
    expectations.

Given Nvidia's strong position in the AI and metaverse markets, it is
not surprising that investors are paying attention to the stock. The
company is also well-managed and has a strong track record of
innovation.

Here are some specific reasons why investors are interested in NVDA
stock amid a rising war in AI and LLM:

-   **Nvidia is a leader in the development of AI hardware and
    software.** The company's GPUs are used by many of the world's
    leading AI researchers and companies.

-   **Nvidia is well-positioned to benefit from the growth of
    LLM.** LLMs are a new type of AI that can generate text, translate
    languages, write different kinds of creative content, and answer
    your questions in an informative way. Nvidia's GPUs are essential
    for training and running LLMs.

-   **Nvidia is investing heavily in the research and development of new
    AI technologies.** The company is committed to maintaining its
    leadership position in the AI market.

Overall, Nvidia is a well-established company with a strong track record
of innovation. The company is well-positioned to benefit from the growth
of AI and LLM, which is why investors are paying attention to the stock.

The code allowed us to plot returns into a time series, providing a
clear visualization of stock performance during the specified period.

```{r Cumulative return plot, fig.cap="Cumulative return of stocks across the analysed period.", echo=FALSE, fig.pos='H'}
# Calculate Cumulative Returns
cumulative_returns <- cumprod(1 + arith_fin_returns)

# Plot Cumulative Return Performance
library(ggplot2)
autoplot(cumulative_returns, facets = NULL) +
  ggtitle("Cumulative Return Performance of the investment universe") +
  ylab("Cumulative Return") +
  xlab("Year")

```

We can define the Minimum Volatility Portfolio (MVP) as a portfolio of
assets with the lowest possible risk for an investor and is located on
the far-left side of the efficient frontier. Note that the minimum
volatility portfolio is also called the minimum variance portfolio or
more precisely the global minimum volatility portfolio (to distinguish
it from other optimal portfolios obtained for higher risk levels).

To implement to global minimum variance portfolio, we need to compute
the covariance matrix as an input parameter for the Markowitz
optimization model.

```{r Covariance matrix, include=FALSE}
cov_matrix <- cov(arith_fin_returns)

```

**Interpreting the Correlation Matrix**

We can highlight the following observations on the correlation matrix
(Fabozzi, 2014):

-   **Predominant positive correlations:** The majority of the
    correlations in the matrix are positive, indicating that most of the
    stocks tend to move in the same direction. This is a common
    characteristic of stocks within the same market, as they are often
    influenced by similar economic factors and market sentiment. The
    plot shows that there is a significant amount of correlation between
    many of the stocks in the portfolio. This is not surprising, as many
    stocks in the same sector or industry tend to move in the same
    direction. For example, the correlation between the tech stocks in
    the portfolio (AAPL, MSFT, GOOGL, TSLA, NVDA, and AMZN) is very
    high. The high correlation between the stocks in the portfolio means
    that the portfolio is not as diversified as it could be. A more
    diversified portfolio would have a lower overall correlation, as the
    stocks would be more likely to move in different directions.

-   **Varying correlation strengths:** The shades of the correlation
    coefficients vary, indicating that the strength of the correlations
    between stocks differs. Some stocks exhibit strong positive
    correlations, while others have weaker correlations. This suggests
    that the portfolio has a mix of stocks with varying degrees of
    co-movement.

**Linking Findings with Markowitz Portfolio Theory**

Markowitz portfolio theory, also known as Modern Portfolio Theory (MPT),
emphasizes the importance of diversification in reducing portfolio risk.
The theory suggests that by combining assets with varying correlations,
investors can achieve a portfolio with a lower overall risk for a given
level of expected return (Markowitz, 1952).

The presence of both positive and negative correlations among the stocks
suggests that there is potential for diversification within the
portfolio. By carefully selecting stocks with different correlation
patterns, investors can construct a portfolio that balances risk and
return.

**Implications for Portfolio Construction**

The correlation matrix provides valuable insights for portfolio
construction. By understanding the correlations between stocks,
investors can make informed decisions about asset allocation and
diversification strategies.

-   **Diversification:** The concept of diversification seeks to enhance
    returns while minimizing risk by investing in a variety of assets
    that will react differently to the same event (s). For example,
    whenever there is unfavorable news about a certain event, i.e. 2008
    sub prime mortgage crisis, the stock market typically declines
    dramatically. Simultaneously, the same news has generally benefited
    the price of specific assets, such as gold. As a result, portfolio
    diversification should include not just diverse stocks inside and
    outside of the same industry, but also diverse asset classes, such
    as bonds and commodities. The diversification effect is a term that
    relates to the link between portfolio correlations and
    diversification. When there is an imperfect correlation between
    assets (positive or negative), the diversification effect occurs. It
    is a critical and successful risk mitigation method since risk
    mitigation may be accomplished without sacrificing profits. As a
    result, any prudent investor who is 'risk cautious' will diversify
    to a certain extent.

-   **Risk Management:** The correlation matrix can be used to assess
    the overall risk profile of the portfolio. A portfolio with
    predominantly strong positive correlations may be more susceptible
    to market downturns, while a portfolio with a mix of positive,
    negative, and weak correlations may exhibit more stability.

-   **Rebalancing:** The correlation matrix can guide rebalancing
    decisions. If certain stocks or sectors become overly correlated,
    investors may consider rebalancing their portfolio to maintain an
    appropriate level of diversification.

In conclusion, the correlation matrix is a valuable tool for
understanding the relationships between assets in a portfolio. By
analyzing the correlation patterns, investors can make informed
decisions about diversification, risk management, and rebalancing
strategies, aligning with the principles of Markowitz portfolio theory.
We observe opportunities for diversification within our investment
universe. It's worth noting that within our investment universe, we do
not find negative correlations, as all the assets exhibit some degree of
correlation to one another.

```{r Correlation matrix, fig.cap="Correlation return of stocks across the analysed period.", echo=FALSE, fig.pos='H'}
corrplot(cor(arith_fin_returns), type='lower', 
         method = "shade", tl.col = 'black', cl.pos = "r", tl.cex = 1)
```

To further complement the analysis of the data gathered, we can run a
statistical analysis of the first moments of the distribution to assess
the performance of each stock and understand their behavior during the
time frame observed. NB: Figures obtained from this statistical analysis
are given on monthly returns.

```{r Summary return, include=FALSE}
summary(arith_fin_returns)
```

Using monthly data to smooth the data and transform it to a close
approximation to the Gaussian distribution has several advantages:

-   **Reduced noise:** Monthly data is less noisy than daily or weekly
    data. This is because it averages out the short-term fluctuations in
    the data.

-   **Improved normality:** Monthly data is more likely to be normally
    distributed than daily or weekly data. This is because the Central
    Limit Theorem states that the distribution of the sum of a large
    number of independent and identically distributed random variables
    will be approximately normal, even if the original distribution is
    not normal.

-   **Easier to model:** Gaussian distributions are easier to model than
    other types of distributions. This is because there are a number of
    well-established statistical methods for modeling Gaussian
    distributions.

There are also some disadvantages to using monthly data to smooth the
data and transform it to a close approximation to the Gaussian
distribution:

-   **Loss of information:** Monthly data is less informative than daily
    or weekly data. This is because it averages out some of the detail
    in the data.

-   **Time lag:** Monthly data has a time lag. This means that it does
    not reflect the latest changes in the underlying data.

Overall, the utility of using monthly data to smooth the data and
transform it to a close approximation to the Gaussian distribution
depends on the specific application. In order to reduce noise and
improve normality, then using monthly data is a good option. However, if
the goal is to capture the latest changes in the data or to preserve all
of the information in the data, then using more frequent data is a
better option.

The data taken in this analysis spans from early January 2019 to August
2023. This is a relatively long period of time, so using monthly data
should be sufficient to reduce noise and improve normality. However, the
data may be subject to have a time lag.

For portfolio optimization under a Markowitz framework, using monthly
data is a good choice to deal with the normality assumption of the
Markowitz model. In addition to that, supplementary statistical analysis
can help understand financial patterns in data:

-   First, density plots, also known as probability density function
    plots, serve the purpose of visualizing data distributions. They
    offer insights into the shape, spread, and central tendencies of
    data, making them crucial for assessing the nature of financial
    asset returns.

-   Second, QQ plots, or quantile-quantile plots, are utilized to
    evaluate whether a dataset adheres to a specific theoretical
    distribution, such as the normal distribution. These plots help
    portfolio managers identify departures from expected distributions,
    facilitating informed investment decisions. Together, these
    techniques aid in the exploration and assessment of financial data,
    enabling portfolio managers to make more informed and data-driven
    choices in their investment strategies.

We can run some more advanced statistical analysis to understand the
asset return behavior of the equities selected in this analysis.
Overall, we can see from both the density plots and the QQ plots that
the monthly show some normality properties that can be beneficial for
our portfolio construction part of the project.

```{r Advanced statistical data, include=FALSE}

# Advanced statistical analysis for the dataset

plot_density(arith_fin_returns)
plot_qq(arith_fin_returns)

```

## 1.4 Modelling part

Modern Portfolio Theory (MPT) is founded on several market and investor
assumptions. Several of these assumptions are stated explicitly, while
others are implied. Markowitz's contributions to (MPT) in portfolio
selection are based on the following basic assumptions: 

-   Investors are rational (they seek to maximize returns while
    minimizing risk, or minimize risk while maximize return).

-   Investors will accept increased risk only if compensated with higher
    expected returns.

-   Investors receive all relevant information regarding their
    investment decision.

-   Investors can borrow or lend an unlimited amount of capital at a
    risk-free rate of interest.

### 1.4.1 Unbiased Global Minimum Variance (GMV) portfolio

The GMV portfolio is only based on the covariance matrix estimation.
This matrix estimator is inversed in the formula to determine the
weights of the portfolio. The unbiased estimator of the inverse
covariance matrix can be approached as :

$$
\hat{\Sigma}{\text{unbiased}} = \frac{1}{T - n - 2} \sum{t=1}^{T} (r_t - \hat{\mu})(r_t - \hat{\mu})'
$$

where $\hat{\mu} = \frac{1}{T} \sum_{t=1}^{T} r_t$ is an estimator for
the mean returns, T the number of observations, n the number of assets
and rt the vector of financial returns for the n assets observed at time
t.

In the context of time series data analysis, one of the crucial
applications is the division of the data set into a training set and a
testing set based on temporal order. This approach is particularly
important when dealing with data that evolves over time, such as stock
prices in this instance.

The training set typically comprises historical data, while the testing
set contains more recent observations. This temporal separation allows
for the evaluation of predictive models and forecasting techniques. By
using historical data to train the model and then assessing its
performance on more recent data, analysts can gauge the model's ability
to make accurate predictions and anticipate future trends. Time series
data applications are essential in fields like finance, where
understanding and forecasting trends over time is important.

For the purpose of modelling, we will shrink the data set into two
different sub-samples. We can define the following parameters:

```{r Subsampling of data, include=FALSE}
num_rows_subsample1 <- 20
total_rows <- nrow(arith_fin_returns)
```

1.  The first sub-sample will cover the first 20 trading month covered
    in the data set.

```{r Subsample 1 data structure, fig.cap="Structure of the first subsample.", echo=FALSE, fig.pos='H'}
subsample1 <- arith_fin_returns[1:num_rows_subsample1, ]
plot_intro(subsample1)
```

2.  The second sub-sample will cover the rest of the data set, covering
    the equivalent of 36 trading month.

```{r Subsample 2 data structure,fig.cap="Structure of the second subsample.", echo=FALSE, fig.pos='H'}
subsample2 <- arith_fin_returns[(num_rows_subsample1 + 1):total_rows, ]
plot_intro(subsample2)

```

We implement the parameters of the model in order to compute the GMV.

```{r Parameters calculations, echo=FALSE}

#Definition of parameters
n <- ncol(subsample1)
T <- nrow(subsample1)
e <- rep(1, n)
perio <- 12

#Compute Sigma (unbiased covariance matrix)
#We proceed with a regularization procedure: In order to compute an inverse, we can add a small positive value to the diagonal of the matrix to make it invertible. This technique is known as "Tikhonov regularization" or "ridge regression".

Sigma <- cov(subsample1) * (T - 1) / (T - n - 2) * perio
lambda <- 1e-4  # Small regularization parameter
Sigma_reg <- Sigma + diag(lambda, ncol(Sigma))
C <- t(e) %*% solve(Sigma_reg) %*% e

#Anticipated volatility can be computed
sigmag <- sqrt(1 / C)
```

After computing the parameters required to implement the unbiased GMV
portfolio, we can compute omega, representing the weightings of the
portfolio as follows.

```{r Omega GMV parameter, include=FALSE}
omega_gmv <- 1 / as.numeric(C) * solve(Sigma_reg) %*% e
```

The GMV portfolio represents an application of Markowitz's portfolio
theory, which focuses on the trade-off between risk and return. However,
the GMV specifically concentrates on risk minimization without directly
considering expected returns. It is a purely risk-focused approach,
optimal in a mean-variance sense when returns are unpredictable or when
a risk-averse investor seeks the lowest possible portfolio variance.

The use of unbiased estimators is crucial for the GMV construction. This
approach assumes that historical returns and covariances are reliable
predictors of future risks. However, this assumption can be problematic,
as historical measures may not accurately represent future market
conditions. Therefore, the GMV portfolio constructed with historical
data may not always achieve the minimum variance out-of-sample. It's
also worth noting that the negative weights in a GMV portfolio imply
short positions, which may not be feasible or desirable for all
investors due to their additional risks and complexities.

In conclusion, the GMV portfolio is a key concept in the optimization of
portfolios under Markowitz's modern portfolio theory. While it offers a
foundation for risk minimization, its real-world application requires
careful consideration of estimation risk, the possibility of model
misspecification, and the investor's ability and willingness to engage
in short selling. The findings from the GMV optimization provide
valuable insights but should be viewed within the broader context of
comprehensive investment strategy and risk management.

The bar chart illustrates the portfolio weights determined by the Global
Minimum Variance (GMV) portfolio optimization method, which is one of
the cornerstones of modern portfolio theory introduced by Harry
Markowitz. The GMV portfolio is constructed to minimize the variance (or
equivalently, the standard deviation) of portfolio returns, under the
assumption of unbiased estimators, meaning that the expected returns are
assumed to be neutral and not influencing the weight allocation. Below
is an analysis of the GMV portfolio weights:

-   **AAPL (Weight: -50.83%)**: The portfolio has a substantial negative
    weight on AAPL. This suggests that, in the context of minimizing
    variance, short positions in AAPL might be used to balance other
    positions' risks. AAPL's negative weight may be due to its
    volatility or correlation characteristics with other assets in the
    portfolio.

-   **MSFT (Weight: 40.45%)**, **GOOGL (Weight: 28.18%)** and **NVDA
    (Weight: 13.97%)**: The following stocks have positive weights,
    indicating that these stocks contribute to the GMV portfolio's
    overall risk profile. They may offer a balance of return potential
    and risk that aligns with the GMV portfolio's objective.

-   **AMZN (Weight: 26.64%), CMCSA (Weight: 48.16%)**, **ADBE (Weight:
    30.07%)**: The significant positive weight on AMZN, CMCSA and ADBE
    suggests that, within the GMV framework, these stocks present
    attractive prospects while providing a potential diversification
    benefit.

-   **TSLA (Weight: -6.8%)**, : Tesla show moderate negative weights,
    potentially offsetting the portfolio's volatility due to its higher
    individual risk or positive correlation with higher-volatility
    assets.

-   **PYPL (Weight: -31.72%)**, Paypal has a heavy negative weight,
    implying a lesser impact on the portfolio's volatility.

-   **ASML (Weight: 1.93%)**: The weight is close to zero, indicating a
    neutral position in terms of its contribution to portfolio variance.

```{r GMV plot , fig.cap="GMV portfolio weights. Each represent a stock weight (from left to right: AAPL, MSFT, GOOGL, AMZN, TSLA, NVDA, PYPL, CMCSA, ADBE, ASML.", echo=FALSE, fig.pos='H'}
barplot(as.numeric(omega_gmv), col = 'black', ylim = c(-0.5, 1))
```

### 1.4.2 Implementation of Principal Component Analysis (PCA)

Principal Component Analysis (PCA) is a technique used to analyze and
reduce the dimensionality of a dataset while retaining as much variance
as possible. We perform the PCA analysis using the second subsample
starting from the trading month number 20 of the sample to the trading
month number 56.

Principal component analysis (PCA) is an unsupervised machine learning
technique that can be used to identify the underlying patterns in a
dataset. PCA works by transforming the dataset into a new set of
variables, called principal components, that are uncorrelated with each
other. The principal components are ordered in terms of how much
variance they explain in the dataset, with the first principal component
explaining the most variance and the last principal component explaining
the least variance.

PCA can be used for a variety of tasks, including dimensionality
reduction, data visualization, and feature extraction. In the context of
portfolio management, PCA can be used to:

-   Identify the underlying factors that drive the returns of the stocks
    in the portfolio.

-   Construct more diversified portfolios by selecting stocks with low
    correlations with each other.

-   Reduce the dimensionality of the portfolio by selecting the most
    important principal components.

For a three factor model, we can approach it mathematically:

$$
\hat{\Sigma}_{3\text{factors}} = \Phi_f \Lambda_f \Phi' + \Sigma\epsilon
$$

The variance of the residuals $\epsilon_i$ can be computed as (Clauss,
2011):

```{=tex}
\begin{equation}
\text{Var}(\epsilon_i) = \text{Var}(r_i) - \phi_{i1}^2 \lambda_1 - \phi_{i2}^2 \lambda_2 - \phi_{i3}^2 \lambda_3
\end{equation}
```
with $\Lambda_f$ representing the diagonal matrix of the first three
eigenvalues of the unbiased estimator of the covariance matrix, $\Phi_f$
the matrix with the first three eigenvectors, and $\Sigma_{\epsilon}$
the diagonal residual covariance matrix determined for each asset $i$.

We can plot the portfolio weights derived from the Hierarchical PCA
implementation:

-   **AAPL (Apple Inc., weight: -12.32%): T**he bar for AAPL shows a
    negative weight, suggesting that the first principal component,
    which this portfolio is likely based on, attributes a negative
    correlation with the stock. It indicates that movements in AAPL's
    stock price might be inversely related to the principal component's
    market factor. Investors might interpret this as AAPL moving against
    a certain market trend captured by the PCA.

-   **MSFT (Microsoft Corporation, weight: 58.13%):** MSFT shows a
    substantial positive weight, indicating a strong positive
    correlation with the market factor. This means that MSFT's stock
    performance is likely to move in the same direction as the factor
    identified by PCA, which could be overall market performance or a
    specific industry trend.

-   **GOOGL (Alphabet Inc., weight: 23.23%)**, **AMZN (Amazon.com Inc.,
    weight: 10.06%)**, and **TSLA (Tesla Inc., -10.04%):** These stocks
    have positive weights but to varying degrees. GOOGL and AMZN, in
    particular, show moderate positive weights, whereas TSLA exhibits a
    relatively smaller positive weight. This suggests that these stocks
    contribute to the portfolio in alignment with the primary factor,
    but their impact is less significant than MSFT.

-   **NVDA (NVIDIA Corporation, weight:** **-0.05%)** and **PYPL (PayPal
    Holdings Inc., weight : -36.08%)**: NVDA has a slight negative
    weight, and PYPL is more heavily negative, indicating that these
    stocks are expected to move opposite the principal factor. This
    could imply that these stocks hedge against the market risk
    identified by PCA or represent a different risk factor within the
    portfolio.

-   **CMCSA (Comcast Corporation, weight: 28.86%)**, **ADBE (Adobe Inc.,
    weight: 27.43%)**, and **ASML (ASML Holding, weight: 11.21% )**:
    CMCSA, ADBE has weighting above 20%, while ASML has a above 10%. The
    positive weights across these stocks reflect a diversification
    strategy, capturing various sectors and risk factors different from
    the major tech companies.

In summary, the PCA portfolio weighting suggests a strategy that
diversifies across different sectors and risk factors. Stocks like MSFT
contribute positively to the factor, whereas companies like PYPL, TSLA
and AAPL provide a counterbalance, potentially reducing overall
portfolio volatility. The negative weights could indicate a hedge
against certain market risks or a bet on different economic drivers.

```{r PCA three factor model, fig.cap="PCA portfolio weights. Each bar represent a stock weight (from left to right: AAPL, MSFT, GOOGL, AMZN, TSLA, NVDA, PYPL, CMCSA, ADBE, ASML.", echo=FALSE, fig.pos='H'}
#PCA one factor

# valp <- eigen(Sigma_reg)$values
# vecp <- eigen(Sigma_reg)$vectors
# vp1 <- vecp[, 1]
# lambda1 <- valp[1]
# varepsilon1 <- diag(Sigma_reg) - vp1 ^ 2 * lambda1
# Sigma_epsilon1 <- diag(varepsilon1, n, n)
# Sigma1 <- (lambda1 * vp1 %*% t(vp1) + Sigma_epsilon1)
# C1 <- t(e) %*% solve(Sigma1) %*% e
# sigmag1 <- sqrt(1 / C1)
# omega1 <- 1 / as.numeric(C1) * solve(Sigma1) %*% e

#plotting the weights for the one factor model
# barplot(as.numeric(omega1), col = 'black')


#PCA for three factor 
valp <- eigen(Sigma_reg)$values
vecp <- eigen(Sigma_reg)$vectors

vp3 <- cbind(vecp[, 1], vecp[, 2], vecp[, 3])
lambda3 <- diag(c(valp[1], valp[2], valp[3]), 3, 3)
varepsilon3 <- diag(Sigma_reg) - vp3 ^ 2 %*% diag(lambda3)
Sigma_epsilon3 <- diag(as.numeric(varepsilon3), n, n)
Sigma3 <- (vp3 %*% lambda3 %*% t(vp3) + Sigma_epsilon3)
C3 <- t(e) %*% solve(Sigma3) %*% e
sigmag3 <- sqrt(1 / C3)
omega3 <- 1 / as.numeric(C3) * solve(Sigma3) %*% e

#plotting the weights for the three factor model
barplot(as.numeric(omega3), col = 'black')
```

**Alternative technique to compute Hierarchical PCA**

Introduction to PCA in Finance: PCA is widely recognized in the
quantitative finance literature for its utility in dimensionality
reduction and identification of latent factors in asset returns. This
technique's ability to transform a dataset into principal
components---linearly uncorrelated variables---facilitates the
understanding of complex market structures (Jolliffe, 2002; Fabozzi et
al., 2014).

Portfolio Management Context: PCA's application in portfolio management
serves to discern the fundamental drivers of asset performance. Through
the lens of principal components, portfolio diversification strategies
can be refined to mitigate systemic risk and enhance returns (Sharpe,
1992).

Hierarchical PCA Application: The hierarchical PCA provides a nuanced
perspective on the asset correlations within the portfolio. This
innovative approach organizes the principal components in a hierarchy,
potentially revealing intricate interdependencies among the assets
(Hardoon et al., 2004).

**Empirical Findings:**

-   PC1 Analysis: The significant loadings on PC1 across diverse assets
    suggest a pervasive market factor, possibly indicative of systematic
    risk or sector movements. The positive and negative weights on tech
    stocks such as AAPL, MSFT, NVDA, and PYPL underscore the
    differential impact of market sentiment on these entities (Campbell
    et al., 1997).

-   PC2 Analysis: PC2's distinct weight pattern, with emphasis on
    companies like AMZN, TSLA, and ASML, implies the presence of a
    growth or volatility factor. This component's representation of
    sector-specific sensitivities highlights the heterogeneity within
    the tech sector and associated industries (Fama and French, 1993).

-   PC3 Analysis: The unique weight distribution of PC3, especially for
    GOOGL and ADBE, suggests that this component captures idiosyncratic
    risks or company-specific attributes, such as innovation intensity
    or business model robustness (Lewellen and Shanken, 2002). Insights
    and Practical Implications:

The decomposition into orthogonal factors elucidates diversification
benefits. The portfolio's structure, as revealed by PCA, aids in the
identification of independent risk factors and the formulation of
hedging strategies (Markowitz, 1952).

**Trade Structuring**

The analysis provides a blueprint for constructing trades that target
specific factors. For example, an investor could structure a trade that
leverages the growth dynamics captured by PC2 (Litterman and Scheinkman,
1991).

**Concluding Remarks**

The hierarchical PCA, as presented, is a potent analytical tool that
enhances our understanding of the risk-return dynamics within a
portfolio of US equities. However, its reliance on historical data
necessitates ongoing validation against evolving market conditions.
Continuous recalibration and sensitivity analysis are imperative for the
robustness of investment strategies predicated on PCA (Lo and MacKinlay,
1990).

```{r PCA three factor model with alternative method., fig.cap="PCA portfolio weights via alternative method. Each bar represent a stock weight (from left to right: AAPL, MSFT, GOOGL, AMZN, TSLA, NVDA, PYPL, CMCSA, ADBE, ASML.", echo=FALSE, fig.pos='H'}
# Perform PCA using prcomp (using subsample 2)

pca_result <- prcomp(subsample2, center = TRUE, scale = TRUE)

# Extract principal component loadings
loadings <- pca_result$rotation

# Variance explained by each principal component
var_explained <- (pca_result$sdev^2) / sum(pca_result$sdev^2)

# Select the number of principal components to include
num_components <- 3  # Adjust as needed

# Weights for the PCA portfolio
weights_pca <- loadings[, 1:num_components] / rowSums(loadings[, 1:num_components])

# Plot PCA portfolio weights

my_colors <- c("red", "blue", "green") # vector of colours
barplot(weights_pca, beside = TRUE, col = my_colors,
        names.arg = colnames(weights_pca),
        legend.text = colnames(weights_pca),
        main = "PCA Portfolio Weights")
```

# 2. Tangency Portfolio and Black-Litterman Approach

## 2.1 Packages

We use the same packages as described on 1.1.

## 2.2 Investment universe

### **2.2.1 Investment universe**

This investment universe is designed to provide diversified exposure
across a range of asset classes, including broad market indices,
emerging market equities, government bonds, commodities, and precious
metals. This selection is intended to balance risk and return while
capturing growth opportunities and providing a hedge against inflation.

-   VTI (Vanguard Total Stock Market ETF): Broad exposure to the global
    stock market.

-   EMGF (iShares MSCI Emerging Markets Multifactor ETF): Exposure to
    emerging markets with favorable exposure to value, quality,
    momentum, and size factors.

-   IEF (iShares 7-10 Year Treasury Bond ETF): Exposure to
    intermediate-term government bonds.

-   DBC (Invesco DB Commodity Index Tracking Fund): Exposure to a basket
    of commodities.

-   GLD (SPDR Gold Trust): Exposure to gold.

### **2.2.2 Economic data**

To connect our investment universe selection to the asset allocation, we
can refer to market outlooks from the prominent Wall Street most
reliable market commentaries. We take the economic data from Goldman
Sachs Asset Management, BlackRock, and JPMorgan Asset Management:

| Firm      | Global GDP Growth | US GDP Growth | Eurozone GDP Growth | China GDP Growth | S&P 500 Earnings | US 10-year Treasury Yield |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
| BlackRock | +3.1%             | +2.3%         | +2.1%               | +5.3%            | +10%             | 3.3%                      |
| GSAM      | +2.8%             | +1.8%         | +0.6%               | +5.0%            | +6%              | 3.5%                      |
| JPMAM     | +3.2%             | +2.0%         | +2.0%               | +5.2%            | +8%              | 3.0%                      |

Source: Data from BlackRock, Goldman Sachs Asset Management (GSAM), and
J.P. Morgan Asset Management (JPMAM), 2023.

On average, the three financial institutions expect global GDP growth of
+3.0% in 2023, US GDP growth of +2.0%, and S&P 500 earnings growth of
+8%. They also expect the US 10-year Treasury yield to reach 3.3%.

In terms of asset allocation, all three institutions are overweight on
equities, with Goldman Sachs Asset Management being the most overweight.
They are also underweight on bonds, with JPMorgan Asset Management being
the most underweight.

Overall, the market outlooks from these three financial institutions
suggest that equities are still the preferred asset class for 2023,
despite the expected slowdown in economic growth. Investors should
consider diversifying their portfolios with other asset classes, such as
bonds and commodities, to reduce risk.

This investment universe is a good option for investors who are looking
for a diversified portfolio that offers the potential for both growth
and income. The assets in this universe are supported by economic data,
market outlook, and investment considerations.

### 2.2.3 Rationale

We have carefully chosen a set of five trackers (ETFs) to represent our
investment universe. An ETF can be defined as a financial product that
is based on a basket of different assets, to replicate the actual
performance of each selected investment. An ETF has more or less the
same proportion of the underlying components of the basket, depending on
the style of management of the asset manager. Below is the
Exchange-Traded Funds (ETF) chosen as the investment universe.

-   **Equities (VTI):** VTI provides broad exposure to the global stock
    market, which is expected to benefit from economic growth.

-   **Emerging market equities (EMGF):** EMGF provides exposure to
    emerging markets with favorable exposure to value, quality,
    momentum, and size factors. Emerging markets have the potential for
    higher growth than developed markets, but they also come with more
    risk. EMGF mitigates some of the risk by investing in companies with
    favorable exposure to specific factors.

-   **Government bonds (IEF):** IEF provides exposure to
    intermediate-term government bonds, which are typically considered
    to be low-risk investments. This can provide stability to a
    portfolio in times of economic uncertainty.

-   **Commodities (DBC):** DBC provides exposure to a basket of
    commodities, which can be a good way to diversify a portfolio and
    hedge against inflation. However, it is important to note that
    commodities are volatile investments.

-   **Precious metals (GLD):** GLD provides exposure to gold, which is a
    traditional safe haven asset that can provide protection against
    inflation and market volatility.

Overall, this investment universe is well-diversified and offers a mix
of assets with different risk and return profiles. This makes it a good
choice for investors with a variety of investment objectives and time
horizons.

Our selection strategy is based on several fundamental considerations:

-   **Investment universe:** The investment universe aims at
    representing different asset classes in order to construct a
    multi-asset portfolio.

-   **Diversification strategy:** Our commitment to constructing a
    well-rounded portfolio has been affirmed through diversification
    across various sectors and industries. Such diversification is a
    critical risk management tool, curbing overexposure to a single
    sector or asset class.

-   **Historical data availability:** The selected trackers benefit from
    a rich repository of historical data and extensive research. The
    accessibility of such data enable these ETFs to rigorous portfolio
    management analysis and comprehensive research.

The provided R code defines the tickers for these trackers, allowing you
to access the financial data. This data can then be employed to conduct
a range of analyses, such as return calculations, risk assessments, and
portfolio optimization, to test and implement various investment
strategies.

We source our data from Yahoo Finance, a highly reputable platform
renowned for its financial data. Our analysis covers a comprehensive
three-and-a-half-year period, allowing us to evaluate the performance of
our selected asset class both before and after the onset of the COVID-19
pandemic.

```{r Investment universe data extraction, include=FALSE}
# Define the stock tickers you want to fetch data for
stock_tickers <- c("VTI", "EMGF", "IEF", "DBC", "GLD")

# Fetch historical stock data from Yahoo Finance
start_date <- "2019-01-01"  # Replace with your desired start date
end_date <- "2023-08-31"    # Replace with your desired end date

# Use getSymbols to fetch data for all stock tickers
stock_data <- getSymbols(stock_tickers, from = start_date, to = end_date, auto.assign = TRUE)
```

## 2.3 Data cleaning and analysis

### 2.3.1 Data cleaning

We initiate data cleaning, a crucial step in data analysis:

-   **Extracting adjusted closing prices:** We use the lapply function
    to obtain adjusted closing prices, commonly used for return
    calculations, for a list of stock tickers. This code iterates
    through each ticker and fetches the adjusted closing prices.

-   **Combining stock returns:** To consolidate the adjusted closing
    prices, we employ cbind, creating a data frame where each column
    represents a specific stock's adjusted closing prices.

-   **Renaming columns:** We label the columns with their corresponding
    stock tickers, facilitating easy identification.

-   **Handling missing data:** We remove rows with missing values from
    the dataset for quality and consistency.

```{r Return calculations, include=FALSE}
# Extract adjusted closing prices (which are typically used for returns)
stock_returns <- lapply(stock_tickers, function(ticker) {
  to.monthly(Ad(get(ticker)), indexAt = 'lastof', OHLC = FALSE)
})

# Combine stock returns into a single data frame
fin_prices <- do.call(cbind, stock_returns)

# Eliminate missing data in time series
fin_return <- na.omit(fin_prices)  # Remove rows with missing values

```

Arithmetic returns are used for performance assessment, offering a clear
view of gains and losses, suitable for short-term analysis, and ensuring
transparency.

```{r Arithmetic returns, include=FALSE}
# Computation of returns
arith_fin_returns = diff(fin_return)/lag(fin_return)
head(arith_fin_returns, n=3)
arith_fin_returns <- arith_fin_returns[-1, ]

```

In order to ensure that the data is properly imported, with non missing
values and proper data cleaning procedure, we can implement this line of
code in order to learn more about data.

```{r Data exploration multi-asset, fig.cap="Data structure of the price imported from Yahoo Finance.", echo=FALSE, fig.pos='H'}
# Data exploration for the return time series
plot_intro(arith_fin_returns)
```

### **2.3.2 Data analysis**

We plot the rebased performance of the trackers selected in our
investment universe. From the graph below, we can clearly see the out
performance of equity tracker (VTI) by a considerable margin with
respected to the other asset classes.

The equity market has outperformed all of the other asset classes
mentioned above since 2019 for a number of reasons.

-   **Strong economic growth:** The global economy has grown at a
    healthy pace since 2019, which has supported corporate earnings
    growth. This has made equities more attractive to investors.

-   **Low interest rates:** Interest rates have been low since 2019,
    which has made equities more attractive relative to other asset
    classes, such as bonds.

-   **Government stimulus:** Governments around the world have enacted a
    number of stimulus measures to support the economy during the
    COVID-19 pandemic. This has boosted consumer spending and
    investment, which has benefited equities.

-   **Corporate earnings growth:** Corporate earnings have grown
    strongly since 2019, as companies have benefited from the strong
    economy and low interest rates. This has made equities more
    attractive to investors.

The equity market is the riskiest of the asset classes mentioned above
because it is more volatile and subject to larger swings in price.
However, it has also been the most rewarding asset class over the long
term, as it has generated higher returns than other asset classes, such
as bonds and commodities.

Here are some additional insights on the outperformance of the equity
market:

-   The equity market has benefited from a number of technological
    trends, such as the rise of e-commerce and cloud computing. These
    trends have led to the growth of new companies and industries, which
    has created new investment opportunities for investors.

-   The equity market has also benefited from the globalization of the
    economy. Companies are now able to operate in multiple countries,
    which has helped them to grow their businesses and increase their
    profits.

-   The equity market has become more accessible to individual investors
    in recent years. This has led to an increase in demand for equities,
    which has helped to drive up prices.

Overall, the equity market has outperformed all of the other asset
classes mentioned above since 2019 due to a number of factors, including
strong economic growth, low interest rates, government stimulus,
corporate earnings growth, technological trends, globalization, and
increased access for individual investors.

```{r Cumulative return plot 2, fig.cap="Cumulative return of the funds over the selected period.", echo=FALSE, fig.pos='H'}

# Calculate Cumulative Returns
cumulative_returns <- cumprod(1 + arith_fin_returns)

# Plot Cumulative Return Performance
library(ggplot2)
autoplot(cumulative_returns, facets = NULL) +
  ggtitle("Cumulative Return Performance of the investment universe") +
  ylab("Cumulative Return") +
  xlab("Year")

```

To enhance our data analysis, we can perform statistical analysis on the
monthly returns of each stock. This helps us evaluate their performance
and behavior during the observed time frame. Please note that the
figures derived from this analysis are presented in monthly returns.

```{r summary statistics multi-asset, include=FALSE}
# Statistical summary of returns for each asset class

summary(arith_fin_returns)
```

As shown previously in the point 1.2 of the project, using monthly data
can smooth short term fluctuations and accommodate the data to better
manipulation when dealing with the normality assumption of certain
finance models. In portfolio management, statistical analysis plays a
key role in understanding financial data patterns. We will focus on the
density plot which visualize data distributions. This method assist
portfolio managers in making data-driven investment decisions, enhancing
the exploration of financial data, and understanding the behavior of
selected equities' returns. As seen from the density plots, the results
can be considered as normally distributed.

```{r Advanced plots Gaussian and QQ, include=FALSE}
# Advanced statistical analysis for the dataset

plot_density(arith_fin_returns)
plot_qq(arith_fin_returns)
```

Correlation is a fundamental concept related to diversification, which
seeks to use poorly correlated and non correlated assets to construct a
portfolio. Diversification aims to boost returns while minimizing risk
by investing in assets that respond differently to various events.
Prudent investors seeking risk mitigation will diversify their
portfolios.

In our investment universe, opportunities for diversification arise.
Defensive assets like gold (TICKER: GLD) can effectively diversify when
combined with more aggressive ones. For instance, the Vanguard Total
Index tracker (TICKER: VTI) has a poor correlation with gold (TICKER:
GLD). iShares 7-10 years Treasuries Index tracker (TICKER: IEF) exhibits
negative correlation with respect to international and emerging market
equities.

```{r Correlation multi-asset portfolio, fig.cap="Correlation of returns of the funds over the selected period.", echo=FALSE, fig.pos='H'}
# Correlation analysis

library(corrplot)
corrplot( cor(arith_fin_returns), type='lower', method = "shade", tl.col = 'black', cl.pos = "r", tl.cex = 1)
```

## 2.4 Modelling of the portfolio

### 2.4.1 Implementing the Tangency portfolio (TP)

In time series data analysis, a crucial application involves splitting
the dataset into training and testing sets based on temporal order. This
is vital when working with data that evolves over time, such as stock
prices or weather observations.

The training set consists of historical data, while the testing set
contains more recent observations. This division allows analysts to
assess predictive models and forecasting techniques. By training the
model on historical data and evaluating it with recent data, we can
determine its ability to make accurate predictions. This is especially
important in finance for understanding and forecasting trends over time.

For modeling purposes, we'll create two sub-samples with defined
parameters.

```{r Subsampling multi-asset portfolio, echo=FALSE}
# Specify the number of rows for the first subsample
num_rows_subsample1 <- 20

# Calculate the total number of rows in your dataset
total_rows <- nrow(arith_fin_returns)
```

1.  The first sub-sample will cover the first 20 trading month covered
    in the data set.

```{r Subsample 1 multi-asset portfolio, fig.cap="Structure of the first subsample.", echo=FALSE, fig.pos='H'}
# Create the first subsample
subsample1 <- arith_fin_returns[1:num_rows_subsample1, ]
plot_intro(subsample1)

```

2.  The second sub-sample will cover the rest of the data set, covering
    the equivalent of 36 trading months.

```{r Subsample 2 multi-asset portfolio, fig.cap="Structure of the second subsample.", echo=FALSE, fig.pos='H'}
# Create the second subsample by excluding the rows in the first subsample
subsample2 <- arith_fin_returns[(num_rows_subsample1 + 1):total_rows, ]
plot_intro(subsample2)
```

```{r parameters of model, include=FALSE}
#We implement the parameters of the model in order to compute the Tangency Portfolio

n <- ncol(subsample1)
T <- nrow(subsample1)
e <- rep(1, n)
perio <- 12
rf <- 0

```

```{r unbiased covariance matrix, include=FALSE}
#The parameter sigma, representing the unbiased covariance matrix (similar to the procedure implemented when computing the GMV portfolio), can be computed using the following procedure

mu <- colMeans(subsample1) * perio - rf
Sigma <- cov(subsample1) * (T - 1) / (T - n - 2) * perio
A <- t(e) %*% solve(Sigma) %*% mu
omega <- 1 / as.numeric(A) * solve(Sigma) %*% mu

returns = mu %*% omega
```

The portfolio allocation consists of both long positions, where
investors expect favorable returns, and short positions, where they
anticipate weaker performance. Here's a more detailed explanation of
each asset class allocation:

Long Positions: The long segment of the portfolio is allocated to assets
where positive performance is expected.

-   **International Equities (Ticker: VTI, Allocation: 17.54%):** This
    segment of the portfolio is dedicated to international equities,
    with VTI making up 17.54% of the overall portfolio. Investors are
    optimistic about the performance of international equities, which is
    why they have allocated a significant portion of their capital to
    this asset class.

-   **US Short-Term Maturity Bond (Ticker: IEF, Allocation: 88.91%):**
    The largest allocation in the long positions is in US short-term
    maturity bonds, represented by IEF. This allocation indicates a
    strong conviction in the stability and income potential of
    short-term bonds.

-   **Emerging Markets (Ticker: EMGF, Allocation: 5.7%):** In the case
    of emerging markets, the allocation is bullish at 5.7%. This
    indicates that investors are taking a positive stance on the
    performance of emerging market assets, expecting their values to
    rise.

-   **Commodities (Ticker: DBC, Allocation: 0.06%):** The allocation to
    commodities, represented by DBC, is even more conservative at 0.06%.
    This suggests a neutral outlook on commodities, which reflects a
    cautious approach towards commodities in the portfolio.

Short Positions: The short segment of the portfolio is allocated to
assets where weak performance is expected.

-   **Gold (Ticker: GLD, Allocation: -12.83%):** Gold is often
    considered a safe-haven asset, and this allocation suggests that
    investors still see value in holding gold as a hedge or store of
    value, albeit at a slightly reduced allocation.

In summary, the portfolio is strategically balanced between long
positions, where investors have confidence in the assets' growth
potential, and short positions, where they are expecting weaker
performance. The specific allocations provide insights into the level of
conviction and sentiment regarding each asset class.

```{r Plot tangency portoflio, fig.cap="Tangency portfolio weights. Each bar represents a fund weight from left to right: VTI, EMGF, IEF, DBC, GLD.", echo=FALSE, fig.pos='H'}
# Plot of Tangency portfolio

barnames <- c("VTI", "EMGF", "IEF", "DBC", "GLD")
barplot(
  as.numeric(omega),
  col = 'Black',
  names.arg = barnames,
  ylim = c(-0.5, 1)
)
```

### 2.4.2 Implementing Black-Litterman approach

**Market views**

In order to construct our views matrix, we can base our assumptions on
the economic outlooks provided from a group of asset managers to
confront outlooks and assess their perspective on markets. We will delve
deeper into the outlooks from BlackRock, Goldman Sachs Asset Management
(GSAM), and J.P. Morgan Asset Management (JPMAM) on gold, international
equities, commodities, short-term US Treasuries, and emerging markets:

**International equity markets**

International equity markets have underperformed US equity markets since
2019. However, they have started to outperform in 2023, as valuations
have become more attractive and corporate earnings growth has picked up.

-   **BlackRock:** BlackRock is neutral on international equities. The
    firm believes that international equities are undervalued, but it is
    cautious due to the risks associated with investing in international
    markets, such as currency fluctuations and political instability.

-   **Goldman Sachs Asset Management (GSAM):** GSAM is neutral on
    international equities. The firm believes that international
    equities are undervalued, but it is cautious due to the risks
    associated with investing in international markets, such as currency
    fluctuations and political instability.

-   **J.P. Morgan Asset Management (JPMAM):** JPMAM is overweight
    international equities. The firm believes that international
    equities are undervalued and that corporate earnings growth will
    pick up in the coming months.

**Emerging market equity**

Emerging market equity has underperformed US equity since 2019. However,
it has started to outperform in 2023, as valuations have become more
attractive and corporate earnings growth has picked up.

-   **BlackRock:** BlackRock is neutral on emerging market equities. The
    firm believes that emerging market equities are undervalued, but it
    is cautious due to the risks associated with investing in emerging
    markets, such as currency fluctuations and political instability.

-   **GSAM:** GSAM is underweight emerging market equities. The firm
    believes that emerging markets are more risky than developed markets
    due to their higher exposure to China and other emerging economies.

-   **JPMAM:** JPMAM is underweight emerging market equities. The firm
    believes that emerging markets are more risky than developed markets
    due to their higher exposure to China and other emerging economies.

**US short-term treasuries**

US short-term treasuries have underperformed most other asset classes
since 2019. This is due to the fact that interest rates have been rising
during this period.

-   **BlackRock:** BlackRock is overweight short-term US Treasuries. The
    firm believes that the outlook for short-term US Treasuries is
    positive, as the Federal Reserve is expected to continue raising
    interest rates to combat inflation.

-   **GSAM:** GSAM is overweight short-term US Treasuries. The firm
    believes that the outlook for short-term US Treasuries is positive,
    as the Federal Reserve is expected to continue raising interest
    rates to combat inflation.

-   **JPMAM:** JPMAM is neutral on short-term US Treasuries. The firm
    believes that the outlook for short-term US Treasuries is neutral,
    as the Federal Reserve is expected to continue raising interest
    rates, but yields are already relatively high.

**Commodities**

Commodities have outperformed most other asset classes since 2019. This
is due to a number of factors, including strong demand from China and
the ongoing war in Ukraine.

-   **BlackRock:** BlackRock is overweight commodities. The firm
    believes that commodity prices will remain supported by strong
    demand from China and the ongoing war in Ukraine.

-   **GSAM:** GSAM is overweight commodities. The firm believes that
    commodity prices will remain supported by strong demand from China
    and the ongoing war in Ukraine.

-   **JPMAM:** JPMAM is overweight commodities. The firm believes that
    commodity prices will remain supported by strong demand from China
    and the ongoing war in Ukraine.

**Gold**

Gold has outperformed most other asset classes since 2019. This is due
to a number of factors, including concerns about global economic growth,
geopolitical tensions, and inflation.

-   **BlackRock:** BlackRock is overweight gold in its portfolios. The
    firm believes that gold is a good hedge against inflation and
    geopolitical risk.

-   **GSAM:** GSAM is overweight gold in its portfolios. The firm
    believes that gold is a good hedge against inflation and
    geopolitical risk.

-   **JPMAM:** JPMAM is overweight gold in its portfolios. The firm
    believes that gold is a good hedge against inflation and
    geopolitical risk.

**Market view overview**

Overall, there is a general convergence of outlooks on gold,
commodities, and short-term US Treasuries. All three asset managers are
overweight these asset classes. However, there is some divergence of
outlooks on international equities and emerging markets. BlackRock and
GSAM are neutral on international equities, while JPMAM is overweight.
GSAM and JPMAM are underweight on emerging markets, while BlackRock is
neutral.

| **Asset class**          | **BlackRock** | **GSAM**    | **JPMAM**   |
|--------------------------|---------------|-------------|-------------|
| Gold                     | Overweight    | Overweight  | Overweight  |
| International equities   | Neutral       | Neutral     | Overweight  |
| Commodities              | Overweight    | Overweight  | Overweight  |
| Short-term US Treasuries | Overweight    | Overweight  | Neutral     |
| Emerging markets         | Neutral       | Underweight | Underweight |

: Data from BlackRock, Goldman Sachs Asset Management (GSAM), and J.P.
Morgan Asset Management (JPMAM), 2023.

In summary, our combined views suggest the following outlook scenario
for each asset class with an expected Q value in percentages :

| Asset Class                 | Ticker | Position               | Percentage |
|-----------------------------|--------|------------------------|------------|
| International Equities      | VTI    | Strongly overweight    | 5%         |
| Emerging Markets            | EMGF   | Relatively overweight  | 1%         |
| US Short Term Maturity Bond | IEF    | Strongly overweight    | 5%         |
| Commodities                 | DBC    | Neutral                | 0%         |
| Gold                        | GLD    | Relatively underweight | -2%        |

Data from BlackRock, Goldman Sachs Asset Management (GSAM), and J.P.
Morgan Asset Management (JPMAM), 2023.

In the Black-Litterman model, the expected returns of individual assets
are represented by the Q vector. The Q vector is defined by the
investor, and it reflects their views on the future performance of each
asset. In the code provided, the investor has specified strong
overweight positions in international equities (VTI) and US short-term
maturity bonds (IEF), a relatively overweight position in emerging
markets (EMGF), and neutral and underweight positions in commodities
(DBC) and gold (GLD), respectively.

Once the Q vector has been defined, the Black-Litterman model can be
used to calculate the optimal portfolio weights. The optimal portfolio
weights are the weights that will maximize the expected return of the
portfolio, subject to the investor's risk constraints.

In summary, the Black-Litterman code you provided defines the expected
returns of individual assets and uses this information to calculate the
optimal portfolio weights.

```{r Q vector values, include=FALSE}
Q <- numeric(5)
Q[1] <- 0.05 # Strongly overweight for International equities (TICKER: VTI)
Q[2] <- 0.01 # Relatively overweight for Emerging Markets (TICKER: EMGF)
Q[3] <- 0.05 # Strongly overweight for US short term maturity bond (TICKER: IEF)
Q[4] <- 0.00 # Neutral for Commodities (TICKER: DBC)
Q[5] <- -0.02 # Relatively underweight for Gold (TICKER: GLD)
tau <- 0.95
```

The Black-Litterman optimization approach is a widely-used method for
improving the estimation of expected returns and making asset allocation
decisions. It addresses the limitations of traditional mean-variance
optimization by incorporating investor views and market equilibrium
considerations.

The weights in a Black-Litterman can be approached as:

$$
\omega = \frac{1}{A} \tilde{\Sigma}^{-1} \tilde{\mu}
$$

with $\tilde{\Sigma}$ the covariance matrix between assets returns of
length $n \times n$, $\tilde{\mu}$ the vector of the expected excess
returns equal to $\mu - r_f e$ with $\mu$ the expected returns, $r_f$
the risk-free rate and $e$ a vector of 1 of length $n$ and finally.

The unbiased estimator for mu and covariance can be approached as
follows:

$$
\tilde{\mu} = \frac{1}{T} \sum_{t=1}^{T} (r_t - r_f)
$$

with rt is as the return of the asset at time t and rf as the risk-free
rate asset return at time t.

The unbiased covariance estimator can be approached similarly as the the
Global Minimum Variance (GMV) case (Clauss, 2011):

$$
\tilde{\Sigma} = \frac{1}{T - n - 2} \sum_{t=1}^{T} (r_t - \hat{\mu})(r_t - \hat{\mu})'
$$

Black-Litterman approach is quantitative approach that integrate
investor views in a relevant way. This method adds to economic
predictions statistical uncertainty. It is based on a Bayesian approach
(Clauss, 2011).

The Black-Litterman returns are the following mixed estimates:

$$
\hat{\mu}_{mixed} = \left( \tau \tilde{\Sigma}^{-1} + \Omega^{-1} \right)^{-1} \left[ \tilde{\Sigma}^{-1} \hat{\mu} + \Omega^{-1} Q \right]
$$

with $Q$ the economic views quantified by average returns, $\tau$ the
confidence parameter in the views and $\Omega$ the matrix of uncertainty
associated with the economic views; we assume that $\Omega$ is a
diagonal matrix with diagonal elements equal to variances of assets
returns.

The following key steps are performed:

-   Mixed estimation of returns: The code starts by computing expected
    returns using mixed estimation. This means combining the market
    equilibrium-based returns (mu) with the views-based returns (Q)
    using a blending process. The parameter tau adjusts the strength of
    the blending. This approach allows investors to incorporate their
    subjective views on assets into the asset allocation process while
    considering the overall market dynamics.

-   Tactical allocation with views directly: This part of the code
    calculates the tactical asset allocation weights based on views
    directly. It uses a matrix A_Q and the matrix of uncertainty in
    views (omega_Q) to determine the optimal portfolio weights. These
    weights reflect the investor's views on specific assets and are
    adjusted according to their confidence in those views.

-   Tactical allocation with mixed estimation: Similarly, this part
    calculates tactical asset allocation weights, but this time, it uses
    the mixed estimation approach. It calculates A_mixed and omega_mixed
    based on the mixed estimation of expected returns. This allows
    investors to take a balanced approach, combining both market
    equilibrium considerations and their own views in the asset
    allocation process.

Black-Litterman offers a flexible framework for investors to incorporate
their insights and views while maintaining a connection to market
equilibrium. It's a valuable tool for optimizing portfolio allocation
decisions, especially when investors have specific expectations or
insights about the market.

```{r Mixed returns BL model, include=FALSE}

#Mixed estimation of returns

Omega <- diag(diag(Sigma), n, n)
mu_mixed <-
  solve(solve(tau * Sigma) + solve(Omega)) %*% (solve(tau * Sigma) %*% mu +
                                                  solve(Omega) %*% Q)

#Tactical allocation with views directly

A_Q <- t(e) %*% solve(Sigma) %*% Q
omega_Q <- 1 / as.numeric(A_Q) * solve(Sigma) %*% Q
#barplot(as.numeric(omega_Q), col = 'black', names.arg = barnames, ylim = c(-0.5,1.5))


```

**Asset Allocation**

We can add the following comments on the new portfolio allocation under
Black-Litterman approach, including asset views.

**Asset Class Allocations**:

-   **International Equities (Ticker: VTI, Allocation: 18.4%)**: The
    allocation to international equities is 18.4%. This allocation
    represents an "overweight" position compared to the neutral stance
    of the BlackRock outlook, indicating a high level of confidence in
    the favorable performance of international equities. However, it's
    essential to note that there are differing views among asset
    managers. BlackRock and GSAM are neutral on international equities,
    neither optimistic nor pessimistic about their outlook, whereas
    JPMAM is "overweight," indicating a bullish perspective. This
    divergence in views reflects the varying assessments of
    international equity performance.

-   **Emerging Markets (Ticker: EMGF, Allocation: 5.9%)**: The
    allocation to emerging markets is 5.9%, indicating a "relatively
    overweight" position. This align poorly with the views formulated by
    or benchmark asset managers. BlackRock outlook takes a neutral
    stance on emerging markets. JPMAM shares this neutral view, while
    GSAM adopts a more cautious stance by being "underweight,"
    indicating a bearish outlook. The divergence in views highlights the
    risk-return trade-off associated with emerging markets.

-   **US Short Term Maturity Bond (Ticker: IEF, Allocation: 92.4%)**:
    The allocation to US short-term maturity bonds is 92.4%, reflecting
    a "strongly overweight" position. This significant overweight
    allocation aligns with the views of both BlackRock and GSAM, which
    are bullish on short-term US Treasuries. In contrast, JPMAM
    maintains a "neutral" position, neither optimistic nor pessimistic.
    Short-term US Treasuries are seen as a favorable option for capital
    preservation and income generation, given the expected rise in
    yields.

-   **Commodities (Ticker: DBC, Allocation:** **1.9%):** The allocation
    to commodities is 1.9%, indicating a "neutral" position. This
    allocation is not consistent with the outlook of all three asset
    managers, which are "overweight" commodities. While commodity prices
    have exhibited volatility, they are expected to remain supported by
    strong demand from China and geopolitical tensions. Nevertheless, we
    take into account the downside potential in our assessment, reducing
    our exposure to commodities overall. We take into account the
    cyclical nature of commodity prices, which may not experience
    continuous growth.

-   **Gold (Ticker: GLD, Allocation: -18.22%)**: The allocation to gold
    is -18.22**%**, reflecting an "underweight" position. This is
    contrarian to the views of all three asset managers, who are
    collectively "overweight" on gold. This indicates a shared belief
    that gold is a sound investment at this time, particularly as it is
    considered a safe-haven asset sought after during periods of
    economic uncertainty. However, we believe, investor won't be
    compensated enough for holding gold in a diversified portfolio.

**Comments on the weightings with respect to the benchmark views**:

-   The portfolio's strong overweight position in international equities
    represents a bullish stance, despite differing views among asset
    managers. BlackRock and GSAM maintain a neutral position, while
    JPMAM's overweight perspective suggests a higher degree of
    confidence in the outlook for international equities.

-   The relatively overweight position in emerging markets aligns with
    the cautious approach recommended by BlackRock. Differing views from
    GSAM and JPMAM indicate varying risk appetites, acknowledging the
    challenges associated with investing in these markets.

-   The significant overweight allocation to US short-term maturity
    bonds is a key feature of the portfolio allocation. This reflects
    confidence in the short-term Treasuries and is supported by
    BlackRock and GSAM's bullish stance, with JPMAM taking a neutral
    position.

-   The relatively neutral allocation to commodities is consistent with
    the cyclical nature of these assets. The portfolio takes a more
    conservative stance, despite expectations of continued strength in
    commodity prices.

-   The relatively underweight position in gold underscores the risk of
    the associated asset class in the short term. Our weighting shows a
    contrarian view on this particular asset class compared to all three
    asset managers.

Overall, the portfolio allocation under the Black-Litterman approach
takes into account a broader spectrum of views from different asset
managers and integrates them into a more specific allocation that
reflects varying degrees of optimism and caution across different asset
classes. Incorporating views into the portfolio has resulted in diverse
adjustments across asset classes, reflecting the investor's evolving
outlook on each. These changes are indicative of a dynamic strategy that
aims to capitalize on various market scenarios. It's crucial to consider
these allocations within the context of the investor's overall
investment objectives and risk tolerance, as they play a pivotal role in
shaping the portfolio's risk-return profile.

**Analysis of the updated asset class allocations**

Our updated asset class allocations are generally consistent with the
economic views of the asset managers we have cited, with some
exceptions.

-   **International Equities:** We have increased our allocation to
    international equities from 17.54% to 18.4%. This remains overweight
    relative to the neutral stance of BlackRock and GSAM, but it is now
    more in line with the overweight stance of JPMAM.

-   **Emerging Markets:** We have also increased our allocation to
    emerging markets from 5.7% to 5.9%. This remains a relatively
    overweight position, given that BlackRock and JPMAM are neutral on
    emerging markets, while GSAM is underweight. However, we have
    carefully considered the risks associated with emerging markets,
    such as currency fluctuations and political instability, and have
    determined that this level of overweight exposure is appropriate for
    our risk tolerance and investment goals.

-   **US Short-Term Treasuries:** We have significantly increased our
    allocation to US short-term treasuries from 88.91% to 92.4%. This is
    now a strongly overweight position, consistent with the bullish
    views of BlackRock and GSAM. We believe that US short-term
    treasuries offer attractive yields and are a good way to preserve
    capital in the current uncertain economic environment.

-   **Commodities:** We have increased our allocation to commodities
    from 0.06% to 1.9%. This is now a neutral position, but it is still
    below the overweight positions of all three asset managers. We have
    taken into account the cyclical nature of commodity prices and the
    potential for downside risk, and have determined that this level of
    exposure is appropriate for our overall portfolio.

-   **Gold:** We have significantly reduced our allocation to gold from
    -12.83% to -18.22%. This is now a strongly underweight position,
    contrary to the overweight positions of all three asset managers. We
    believe that gold's safe-haven status is overvalued and that it is
    not a good investment for our portfolio at this time.

**Overall Assessment**

Our updated asset class allocations are more overweight international
equities, emerging markets, and US short-term treasuries than the
consensus view. We are also more underweight commodities and gold than
the consensus view.

**Conclusion**

We have carefully considered all of the relevant factors before making
our asset class allocations. We believe that our current allocations are
appropriate for our risk tolerance, investment goals, and the current
economic environment. We will continue to monitor the economic outlook
and adjust our allocations as needed.

```{r Tatical allocation Omega_mixed plot,  fig.cap="BL portfolio weights. Each bar represents a fund weight from left to right: VTI, EMGF, IEF, DBC, GLD.", echo=FALSE, fig.pos='H'}
#Tactical allocation with mixed estimation
A_mixed <- t(e) %*% solve(Sigma) %*% mu_mixed
omega_mixed <- 1 / as.numeric(A_mixed) * solve(Sigma) %*% mu_mixed

#Plot for the mixed view allocation
barplot(as.numeric(omega_mixed), col = 'black', names.arg = barnames, ylim = c(-1,1))
```

# 3. Portfolio Insurance Strategies

Portfolio insurance strategies are designed to protect portfolios from
downside risk. They work by hedging against losses in the stock market.
There are two main types of portfolio insurance strategies:

-   **Dynamic portfolio insurance:** Dynamic portfolio insurance
    strategies adjust the portfolio's allocation to risky assets over
    time. This is done in response to changes in the market.

-   **Static portfolio insurance:** Static portfolio insurance
    strategies maintain a fixed allocation to risky assets. This
    allocation is determined in advance and is not adjusted over time.

## 3.1 Packages

The same packages are referenced in 1.1

## 3.2 OBPI and CPPI strategies

We create the parameters for the simulation.

### 3.2.1 Parameters of the modelling

**Simulation Setup**

-   The expected annual return (mu) is set to 5%.

-   Annual volatility (sigma) is 20%.

-   The initial price of the equity is \$100.

-   The risk-free rate is 2% per annum.

-   The time horizon is 1 year, divided into 12 trading months.

-   The number of trials for the Monte Carlo simulation is 10,000.

**Equity price simulation**

Equity prices are simulated using a geometric Brownian motion model,
where the drift and diffusion components are based on the input
parameters. The script generates a matrix of equity price paths.

**Strategies implementation**

-   **OBPI strategy:** Uses Black-Scholes to price call options on the
    equity at each step.

-   **CPPI strategy**: Adjusts the exposure to the risky asset based on
    a pre-defined floor and a multiplier that determines the level of
    investment in the risky asset relative to the cushion (the amount by
    which the asset value exceeds the floor).

### 3.2.2 Structure of the code

The code structure is as follows:

1.  **Function Declaration:** The function **`simulate_scenario`** is
    declared with a number of parameters:

    -   **`rf_scenario`**: A specific risk-free rate to use for the
        scenario.

    -   **`n_sim`**: The number of simulations to run (default is
        10,000, but it doesn't seem to be used in the body of the
        function).

    -   **`stress`**, **`sigma`**, **`mu`**, **`strike`**: Various
        constants used in the simulations, each with their default
        values.

2.  **Constants Initialization:** Some internal constants such as
    **`delta`**, **`mat`**, and **`tol`** are defined. The **`delta`**
    represents a time step, **`mat`** represents the maturity (fixed to
    1), and **`tol`** represents the tolerance (fixed to 0).

3.  **Random Uniform Sequence:** A seed is set for reproducibility
    purposes, and then a random uniform sequence **`u`** of length
    **`n`** is generated.

4.  **Moments Calculation:** Moments on the simulation path for
    risk-free rate, expected return, and volatility are computed.

5.  **Stock Return and Equity Paths Simulation:** Stock returns **`r`**
    are simulated using the quantile function of the normal distribution
    (**`qnorm`**). Equity price paths for the stock (**`equity`**) and a
    risk-neutral pricing scenario (**`equityRNP`**) are then computed
    using the cumulated product function (**`cumprod`**).

6.  **Call Option Simulation:** The call option price is simulated using
    the Black-Scholes formula, considering the current equity price, the
    strike price, risk-free rate, volatility, and time to maturity.

7.  **Floor Value Calculation:** The minimum guaranteed value
    (**`floor`**) is calculated based on the risk-free rate and time.

8.  **OBPI Simulation:** Option Based Portfolio Insurance (OBPI) is
    simulated using the **`floor`** and **`call`** values to determine
    the gearing and subsequently the OBPI call values.

9.  **CPPI Simulation:** Constant Proportion Portfolio Insurance (CPPI)
    strategy is simulated in this section. It involves calculating
    multiple values like the cushion, multiplier, exposure ex-ante, and
    exposure ex-post. A loop is used to compute these values for each
    time step.

For the Monte Carlo simulation:

1.  **Implementation of the Monte Carlo simulation on the data:** The
    model is performed and results are obtained for this quantitative
    technique.

2.  **Return Statement:** The function finally returns a list containing
    the simulated equity, floor, OBPI call, and CPPI values.

3.  **Visualization**: The script includes plotting functions to
    visualize the simulated price paths for equity, OBPI, and CPPI
    strategies, as well as histograms of the final values after the
    simulation period.

4.  **Results summary**: The script calculates summary statistics for
    the final values of equity, OBPI, and CPPI strategies, which include
    measures like mean, median, and range.

5.  **Return and volatility calculation**: Monthly returns are
    calculated for each strategy. The mean monthly return for each
    strategy is computed. Volatility is annualized by multiplying the
    monthly volatility by the square root of 12 (assuming monthly
    returns are uncorrelated).

6.  **Results consolidation**: A data frame is created to hold the mean
    annualized return and annualized volatility for each strategy. The
    results are printed, which would provide insights into the
    performance and risk of each strategy.

```{r CPPI and CPP model script, include=FALSE}

# Create a function to simulate a scenario using given parameters
simulate_scenario <- function(rf_scenario, n_sim = 10000, stress = 0.20, sigma = 0.20, mu = 0.05, strike = 100) {
  # Define constants
  delta <- 1 / 12
  mat <- 1
  tol <- 0
  
  # Set a seed for reproducibility
  set.seed(1234)
  
  # Calculate the number of simulation steps
  n <- mat / delta
  # Generate a random uniform sequence of length n
  u <- runif(n)
  
  # Calculate moments on the simulation path
  rf1 <- (1 + rf_scenario) ^ delta - 1
  mu1 <- (1 + mu) ^ delta - 1
  sigma1 <- sigma * sqrt(delta)
  
  # Simulate stock returns
  r <- qnorm(u, mu1, sigma1)
  # Simulate equity price paths
  equity <- cumprod(c(strike, 1 + r))
  rPRN <- qnorm(u, rf1, sigma1)
  equityRNP <- cumprod(c(strike, 1 + rPRN))
  
  # Simulate the call option price
  d0 <- ((rf_scenario - sigma^2 / 2) * (mat - (0:(n-1)) * delta) + log(equity[-(n + 1)] / strike)) / 
    (sigma * sqrt(mat - (0:(n-1)) * delta))
  d1 <- d0 + sigma * sqrt(mat - (0:(n-1)) * delta)
  call <- c(equity[-(n + 1)] * pnorm(d1) - strike * exp(-rf_scenario * (mat - (0:(n-1)) * delta)) * pnorm(d0),
            max(0, equityRNP[n + 1] - strike))
  
  # Simulate the floor (minimum guaranteed value)
  floor <- strike / (1 + rf_scenario) ^ (mat - 0:n * delta)
  
  # Simulate OBPI (Option Based Portfolio Insurance) 
  gearing <- (strike - floor[1]) / call[1]
  obpi_call <- c(strike, floor[-1] + gearing * call[-1])
  
  # Simulate CPPI (Constant Proportion Portfolio Insurance)
  cppi <- numeric(n + 1)
  cushion <- numeric(n + 1)
  multiplier <- numeric(n + 1)
  expo_exante <- numeric(n + 1)
  expo_expost <- numeric(n + 1)
  
  cppi[1] <- strike
  cushion[1] <- cppi[1] - floor[1]
  multiplier[1] <- 1 / stress
  expo_exante[1] <- multiplier[1] * cushion[1]
  expo_expost[1] <- expo_exante[1]
  boundary_inf <- multiplier[1] * (1 - tol)
  boundary_sup <- multiplier[1] * (1 + tol)
  
  # Loop to calculate CPPI values
  for (i in 1:n) {
    expo_exante[i + 1] <- expo_expost[i] * equity[i + 1] / equity[i]
    cppi[i + 1] <- expo_exante[i + 1] + (cppi[i] - expo_expost[i]) * floor[i + 1] / floor[i]
    cushion[i + 1] <- cppi[i + 1] - floor[i + 1]
    multiplier[i + 1] <- expo_exante[i + 1] / cushion[i + 1]
    expo_expost[i + 1] <- ifelse(multiplier[i + 1] < boundary_inf || multiplier[i + 1] > boundary_sup, multiplier[1], multiplier[i + 1]) * 
      ifelse(cushion[i + 1] < 0, 0, cushion[i + 1])
  }
  
  # Return the results as a list
  return(list(equity = equity, floor = floor, obpi_call = obpi_call, cppi = cppi))
}

```

## 3.3 Sensitivity analysis

We assess the following variables to understand how they can affect the
payoff of the modelled OBPI and CPPI portfolios:

1.  **Risk-Free Rate (`rf`)**: The risk-free rate affects the present
    value of the strike (used in calculating the floor). An increase in
    the risk-free rate decreases the present value, while a decrease
    increases it. The code demonstrates this sensitivity by simulating
    three scenarios: base, increased, and decreased risk-free rate.

2.  **Stress Value (`stress`)**: Stress value in the code defines the
    risk level for CPPI strategy. It affects the multiplier that
    dictates how much of the cushion (difference between current
    portfolio value and floor) is invested in risky assets.

3.  **Volatility (`sigma`)**: Volatility represents the uncertainty or
    risk regarding the magnitude of changes in an asset's value. A
    higher volatility indicates that an asset's value can potentially be
    spread out over a larger range of values. In the simulation,
    volatility affects the returns and also the Black-Scholes-like
    calculation for the call option.

4.  **Return (`mu`)**: The expected return on the risky asset. This
    impacts the drift of the simulation path. A higher return would
    generally lead to higher asset values, all else being equal.

5.  **Strike Price (`strike`)**: This represents an initial reference
    value from which different strategies are assessed. In the code, it
    acts as the initial value for Equity, OBPI, and CPPI. Changes in
    strike price will directly affect these initial values.

We analyse each variable and the sensitivity to different variations for
each parameters.

```{r Sensitivity values for variables, include=FALSE}
# Sensitivity analysis: generate results for variations in each parameter
rf_values <- seq(0.02, 0.10, by = 0.01)
stress_values <- seq(0.10, 0.30, by = 0.01)
sigma_values <- seq(0.10, 0.30, by = 0.01)
mu_values <- seq(0.01, 0.09, by = 0.01)
strike_values <- seq(90, 110, by = 1)

results_rf <- lapply(rf_values, function(rf_scenario) simulate_scenario(0.02, rf_scenario = rf_scenario))
results_stress <- lapply(stress_values, function(stress) simulate_scenario(0.02, stress))
results_sigma <- lapply(sigma_values, function(sigma) simulate_scenario(0.02, stress = 0.20, sigma = sigma))
results_mu <- lapply(mu_values, function(mu) simulate_scenario(0.02, stress = 0.20, mu = mu))
results_strike <- lapply(strike_values, function(strike) simulate_scenario(0.02, strike = strike))

```

We plot the results for the different sensitivities analysed.

```{r Plotting for sensitivities, include=FALSE}

plot_results <- function(results, title) {
  t <- 1:length(results$equity)

  # Convert the results into a data frame for plotting
  df <- data.frame(
    t = rep(t, 4),
    Value = c(results$equity, results$floor, results$obpi_call, results$cppi),
    Type = factor(rep(c("Equity", "Floor", "OBPI", "CPPI"), each=length(t)))
  )
  
  # Check if 'df' exists and is a data frame
  if (!exists("df") || !is.data.frame(df)) {
    stop("Data frame 'df' does not exist or is not a data frame.")
  }

  # Ensure the data frame has the necessary columns
  if (!all(c("t", "Value", "Type") %in% names(df))) {
    stop("Data frame 'df' does not contain the required columns.")
  }

  # Generate the plot
  ggplot(df, aes(x = t, y = Value, color = Type)) +
    geom_line() +
    labs(title = title, x = "Time", y = "Value", color = "Legend") +
    scale_color_brewer(palette = "Set1") +
    theme_bw() +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      legend.title = element_text(size = 11),
      legend.text = element_text(size = 10),
      legend.position = "bottom",
      legend.box.background = element_rect(color = "black", linewidth = 0.5),
      panel.grid.major = element_line(linewidth = 0.5, linetype = 'solid', color = "white"),
      panel.grid.minor = element_blank(),
      plot.margin = margin(5.5, 5.5, 5.5, 5.5)
    )
}

```

**Risk-free rate (rf)**

-   **Increase:** An increase in the risk-free rate will decrease the
    present value of the strike, which will increase the cost of the put
    option used in OBPI and CPPI. This will lead to lower payoffs for
    both strategies.

-   **Decrease:** A decrease in the risk-free rate will increase the
    present value of the strike, which will decrease the cost of the put
    option used in OBPI and CPPI. This will lead to higher payoffs for
    both strategies.

```{r Risk-free rate,  fig.cap="Sensitivity analysis using the risk-free rate.", echo=FALSE, fig.pos='H'}
plot_results(results_rf[[2]], "Sensitivity analysis: Risk-free rate variation")
```

**Stress value (stress)**

-   **Increase:** An increase in the stress value will increase the
    multiplier used in CPPI, which will lead to a higher allocation to
    risky assets. This will increase the potential upside of the
    strategy, but it will also increase the downside risk.

-   **Decrease:** A decrease in the stress value will decrease the
    multiplier used in CPPI, which will lead to a lower allocation to
    risky assets. This will decrease the potential upside of the
    strategy, but it will also decrease the downside risk.

```{r Stress value,fig.cap="Sensitivity analysis using the stress value.", echo=FALSE, fig.pos='H'}
plot_results(results_stress[[2]], "Sensitivity analysis: Stress value variation")
```

**Volatility (sigma)**

-   **Increase:** An increase in volatility will increase the cost of
    the put option used in OBPI and CPPI. It will also increase the
    potential upside of CPPI, as the portfolio will be more exposed to
    risky assets. However, it will also increase the downside risk of
    CPPI.

-   **Decrease:** A decrease in volatility will decrease the cost of the
    put option used in OBPI and CPPI. It will also decrease the
    potential upside of CPPI, as the portfolio will be less exposed to
    risky assets. However, it will also decrease the downside risk of
    CPPI.

```{r Volatility plot, fig.cap="Sensitivity analysis using volatility.", echo=FALSE, fig.pos='H'}
plot_results(results_sigma[[2]], "Sensitivity analysis: Volatility variation")
```

**Return (mu)**

-   **Increase:** An increase in the expected return will increase the
    value of the risky assets, which will lead to higher payoffs for
    both OBPI and CPPI.

-   **Decrease:** A decrease in the expected return will decrease the
    value of the risky assets, which will lead to lower payoffs for both
    OBPI and CPPI.

```{r Return mu plot, fig.cap="Sensitivity analysis using return (mu).", echo=FALSE, fig.pos='H'}
plot_results(results_mu[[2]], "Sensitivity analysis: Return (mu) variation")
```

**Strike price (strike)**

-   **Increase:** An increase in the strike price will increase the cost
    of the put option used in OBPI and CPPI. It will also decrease the
    initial value of the risky assets, which will lead to lower payoffs
    for both strategies.

-   **Decrease:** A decrease in the strike price will decrease the cost
    of the put option used in OBPI and CPPI. It will also increase the
    initial value of the risky assets, which will lead to higher payoffs
    for both strategies.

```{r Strike plot, fig.cap="Sensitivity analysis using strike price.", echo=FALSE, fig.pos='H'}
plot_results(results_strike[[2]], "Sensitivity analysis: Strike price variation")
```

In general, OBPI and CPPI are designed to protect portfolios from
downside risk. However, they both have different trade-offs between risk
and reward. OBPI is more aggressive, with higher potential upside but
also higher downside risk. CPPI is more conservative, with lower
potential upside but also lower downside risk.

The best strategy to use will depend on the individual investor's risk
tolerance and investment goals. Investors who are more risk-averse may
prefer CPPI, while investors who are more risk-tolerant may prefer OBPI.

## 3.4 Monte Carlo simulation

### **3.4.1 Overview and utility**:

-   Monte Carlo simulation is a computational technique that uses random
    sampling to obtain numerical results.

-   It is particularly useful for assessing the impact of risk and
    uncertainty in prediction and forecasting models.

-   To account for the variability in financial markets and model
    outcomes that are not deterministic.

-   To create a range of possible outcomes and the probabilities that
    they will occur for uncertain variables.

-   To help in making informed decisions under uncertainty by
    considering different scenarios and their potential impacts.

### **3.4.2 Components of Monte Carlo simulation in finance**

1.  **Randomness**:

    -   Incorporates elements of randomness reflecting the uncertainty
        and volatility in financial markets.

2.  **Statistical Properties**:

    -   Uses statistical properties (mean, variance) of historical data
        to simulate future price movements.

3.  **Time Series Modeling**:

    -   Models the evolution of financial instruments over time using
        time series analysis.

### **3.4.3 Application and results in this exercise**

1.  **Equity Price Simulation**:

    -   Simulated using a stochastic process (Geometric Brownian Motion)
        to reflect the random nature of stock prices.

    -   Incorporates drift (expected return) and diffusion (volatility)
        derived from historical data.

2.  **Investment Strategies**:

    -   **OBPI**: Models an options-based strategy that provides
        downside protection.

    -   **CPPI**: A dynamic allocation strategy that adjusts exposure
        based on a predetermined cushion.

3.  **Simulation Execution**:

    -   Runs the simulation over a large number of trials to capture a
        broad range of possible outcomes.

    -   Each trial represents a potential future state of the market or
        asset price.

4.  **Visualization**:

    -   Price path plots for the simulated strategies over time.

    -   Histograms showing the distribution of final values from the
        simulation.

5.  **Summary Statistics**:

    -   Provides key measures like mean, median, standard deviation, and
        percentiles to summarize the simulation results.

6.  **Comparative Analysis**:

    -   Compares the performance and risk of different strategies
        (Equity, OBPI, CPPI).

    -   Helps in understanding the trade-offs between return and risk.

```{r Monte Carlo script, include=FALSE}

simulate_scenario <- function(rf_scenario, n_sim = 10000, stress = 0.20, sigma = 0.20, mu = 0.05, strike = 100) {
  delta <- 1 / 12  # monthly steps
  mat <- 1  # one year
  n <- mat / delta  # number of steps
  
  # Matrices to store simulation results
  equity_paths <- matrix(nrow = n_sim, ncol = n + 1)
  obpi_calls <- matrix(nrow = n_sim, ncol = n + 1)
  cppi_values <- matrix(nrow = n_sim, ncol = n + 1)
  
  # Outer loop for each simulation
  for (sim in 1:n_sim) {
    u <- runif(n)  # uniform random numbers for the entire path
    
    # Calculate monthly returns and simulate price path
    rf1 <- (1 + rf_scenario) ^ delta - 1
    mu1 <- (1 + mu) ^ delta - 1
    sigma1 <- sigma * sqrt(delta)
    
    r <- qnorm(u, mean = mu1, sd = sigma1)  # convert to normal distribution
    equity <- cumprod(c(strike, 1 + r))  # simulate equity path
    
    # Calculate option prices along the path
    d1 <- (log(equity[-(n+1)] / strike) + (rf_scenario + sigma^2 / 2) * (mat - (0:(n-1)) * delta)) / (sigma * sqrt(mat - (0:(n-1)) * delta))
    d2 <- d1 - sigma * sqrt(mat - (0:(n-1)) * delta)
    call <- equity[-(n+1)] * pnorm(d1) - strike * exp(-rf_scenario * (mat - (0:(n-1)) * delta)) * pnorm(d2)
    
    floor <- strike / (1 + rf_scenario) ^ (mat - 0:n * delta)  # simulate floor values
    
    # OBPI strategy
    gearing <- (strike - floor[1]) / call[1]
    obpi_call <- c(strike, floor[-1] + gearing * call[-1])
    
    # CPPI strategy
    cppi <- numeric(n + 1)
    cppi[1] <- strike
    multiplier <- 1 / stress
    for (i in 1:n) {
      cushion <- cppi[i] - floor[i]
      expo_exante <- multiplier * cushion
      cppi[i + 1] <- expo_exante * equity[i + 1] / equity[i] + (cppi[i] - expo_exante) * (1 + rf_scenario)^delta
    }
    
    # Store the results of this simulation
    equity_paths[sim, ] <- equity
    obpi_calls[sim, ] <- obpi_call
    cppi_values[sim, ] <- cppi
  }
  
  # Average the results across all simulations
  list(
    average_equity = rowMeans(equity_paths),
    average_obpi_call = rowMeans(obpi_calls),
    average_cppi = rowMeans(cppi_values)
  )
}

# Run the Monte Carlo simulation with specified parameters
set.seed(123)  # Setting seed for reproducibility
mc_results <- simulate_scenario(rf_scenario = 0.02, n_sim = 10000)

```

### 3.4.4 Histogram simulation plot

The three histograms below represent the distribution of final values
from a Monte Carlo simulation for an equity simulation and two
investment strategies, CPPI (Constant Proportion Portfolio Insurance)
and OBPI (Option-Based Portfolio Insurance). Here is an analysis of
each:

This histogram displays the frequency distribution of the final values
of a simulated equity investment over a given period. The distribution
is bell-shaped and symmetric, suggesting a normal distribution of final
equity prices. The central peak is around the 100 value mark, which may
indicate that the average final price is close to the initial price
(assuming the initial price was 100). There's a noticeable spread on
both sides of the peak, which shows variability in the equity simulation
outcomes.

```{r Monte Carlo plot 4 script, fig.cap="Histogram plot of final equity values.", echo=FALSE, fig.pos='H'}
# Histogram for final equity values
hist(mc_results$average_equity, main="Histogram of Final Equity Values", xlab="Value", col="red", breaks=50)
```

The OBPI histogram also presents a right-skewed distribution, similar to
the CPPI strategy, but the peak is closer to the 100 value mark and the
distribution is more concentrated. This indicates that the OBPI strategy
outcomes are more tightly clustered around the peak, with fewer
instances of both higher and lower values compared to the CPPI strategy.
The strategy seems to offer a balance between protecting against
downside risk and capturing some upside potential.

```{r Monte Carlo plot 5 script, fig.cap="Histogram plot of final OBPI strategy values.", echo=FALSE, fig.pos='H'}
# Histogram for final OBPI strategy values
hist(mc_results$average_obpi_call, main="Histogram of Final OBPI Strategy Values", xlab="Value", col="blue", breaks=50)
```

The CPPI histogram shows a right-skewed distribution, indicating that
most of the final values are concentrated on the left side but there is
a long tail towards higher values. The peak of the distribution is just
above the 100 value mark, and the spread is narrower than the equity
histogram, which may suggest less variability in the CPPI strategy
outcomes compared to the equity simulation. The right skewness might
also reflect a floor mechanism characteristic of CPPI strategies that
limit downside risk but allow for participation in upside potential.

```{r Monte Carlo plot 6 script, fig.cap="Histogram plot of final CPPI strategy values.", echo=FALSE, fig.pos='H'}
# Histogram for final CPPI strategy values
hist(mc_results$average_cppi, main="Histogram of Final CPPI Strategy Values", xlab="Value", col="green", breaks=50)
```

## References

-   Black, F., & Litterman, R. (1992). Global Portfolio Optimization.
    *Financial Analysts Journal*, 48(5), 28-43.

-   Bodie, Z., Kane, A., & Marcus, A. J. (2018). *Investments* (11th
    ed.). McGraw-Hill Education.

-   Campbell, J. Y., Lo, A. W., & MacKinlay, A. C. (1997). *The
    Econometrics of Financial Markets*. Princeton University Press.

-   Clauss, P. Gestion de Portfeuille: Une Approche Quantitative (2011).
    Edition Dunod.

-   Elton, E. J., Gruber, M. J., Brown, S. J., & Goetzmann, W. N.
    (2006). *Modern Portfolio Theory and Investment Analysis* (7th ed.).
    Wiley.

-   Fabozzi, F. J., Focardi, S. M., & Kolm, P. N. (2014). *Quantitative
    Equity Investing: Techniques and Strategies*. John Wiley & Sons.

-   Fama, E. F., & French, K. R. (1993). Common risk factors in the
    returns on stocks and bonds. *Journal of Financial Economics*,
    33(1), 3-56.

-   Hardoon, D. R., Szedmak, S., & Shawe-Taylor, J. (2004). Canonical
    correlation analysis: An overview with application to learning
    methods. *Neural Computation*, 16(12), 2639-2664.

-   Hull, J. C. (2017). *Options, Futures, and Other Derivatives* (10th
    ed.). Pearson.

-   Jolliffe, I. T. (2002). *Principal Component Analysis*. Springer.

-   Lewellen, J., & Shanken, J. (2002). Learning, asset-pricing tests,
    and market efficiency. *Journal of Finance*, 57(3), 1113-1145.

-   Litterman, R. B., & Scheinkman, J. (1991). Common factors affecting
    bond returns. *Journal of Fixed Income*, 1(1), 54-61.

-   Lo, A. W., & MacKinlay, A. C. (1990). When are contrarian profits
    due to stock market overreaction? *Review of Financial Studies*,
    3(2), 175-205.

-   Markowitz, H. (1952). Portfolio selection. *The Journal of Finance*,
    7(1), 77-91.

-   Sharpe, W. F. (1992). Asset allocation: Management style and
    performance measurement. *Journal of Portfolio Management*, 18(2),
    7-19.

### Market outlook

-   Goldman Sachs Global Investment Strategy Group, "Midyear Outlook
    2023: Resilience in the Face of Adversity" (June 2023).
-   JPMorgan Asset Management, "Investment Outlook for 2023: Slow-motion
    slowdown" (June 2023).
-   BlackRock Investment Institute, "Midyear Global Outlook: Navigating
    a period of uncertainty, but not without opportunities" (June 2023).
